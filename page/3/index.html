<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"qiweipeng.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="齐卫鹏的博客">
<meta property="og:url" content="https://qiweipeng.github.io/page/3/index.html">
<meta property="og:site_name" content="齐卫鹏的博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="齐卫鹏">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://qiweipeng.github.io/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>齐卫鹏的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">齐卫鹏的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">欢迎</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://qiweipeng.github.io/2020/10/09/my-mac-initial-configuration/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="齐卫鹏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="齐卫鹏的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/09/my-mac-initial-configuration/" class="post-title-link" itemprop="url">Mac 电脑的个人配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-10-09 23:19:25" itemprop="dateCreated datePublished" datetime="2020-10-09T23:19:25+08:00">2020-10-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-26 15:58:51" itemprop="dateModified" datetime="2024-11-26T15:58:51+08:00">2024-11-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文记录自己新装电脑后的软件安装和个性化配置，以及之后的维护。</p>
<h2 id="软件安装"><a href="#软件安装" class="headerlink" title="软件安装"></a>软件安装</h2><h3 id="App-Store"><a href="#App-Store" class="headerlink" title="App Store"></a>App Store</h3><ul>
<li>1Password</li>
<li>Spark</li>
<li>Fantastical</li>
<li>Todoist</li>
<li>Notability</li>
<li>MindNode</li>
<li>Drafts</li>
<li>Reeder</li>
<li>Xcode</li>
<li>Sequel Ace</li>
<li>Wechat</li>
<li>QQ</li>
<li>Pages</li>
<li>Keynote</li>
<li>Numbers</li>
<li>WPS Office</li>
<li>Apple Developer</li>
<li>Swift Playgrounds</li>
<li>CloudMounter</li>
<li>The Unarchiver</li>
<li>Magnet</li>
<li>Bear</li>
<li>Amphetamine</li>
<li>Petrify</li>
<li>Cleaner for Xcode</li>
<li>quicktype</li>
</ul>
<h3 id="Homebrew"><a href="#Homebrew" class="headerlink" title="Homebrew"></a>Homebrew</h3><p>安装 <a target="_blank" rel="noopener" href="https://brew.sh/">Homebrew</a>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/bin/bash -c &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)&quot;</span><br></pre></td></tr></table></figure>

<p>使用 Homebrew 安装软件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew install &lt;name&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>mysql</li>
<li>git</li>
<li>sqlite</li>
<li>nvm（如果安装多版本 node）</li>
<li>node（如果只安装单版本 node）</li>
</ul>
<p>使用 <code>brew cask</code> 安装应用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew install --cask &lt;name&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>android-studio</li>
<li>google-chrome</li>
<li><del>oracle-jdk</del></li>
<li>openjdk</li>
<li>openjdk@8</li>
<li>appcleaner</li>
<li>iina</li>
<li>pdf-expert</li>
<li>baidunetdisk</li>
<li>imazing</li>
<li>picgo</li>
<li>db-browser-for-sqlite</li>
<li>iterm2</li>
<li>postman</li>
<li>downie</li>
<li>moneywiz</li>
<li>fliqlo</li>
<li>mweb</li>
<li>visual-studio-code</li>
<li>github</li>
<li>notion</li>
<li>dash</li>
<li>sketch</li>
<li>figma</li>
<li>feishu</li>
</ul>
<h3 id="手动安装"><a href="#手动安装" class="headerlink" title="手动安装"></a>手动安装</h3><ul>
<li>SF Symbols</li>
<li>ClashX</li>
<li><del>trojan-qt5</del></li>
</ul>
<h2 id="配置和维护"><a href="#配置和维护" class="headerlink" title="配置和维护"></a>配置和维护</h2><h3 id="需要激活的-App"><a href="#需要激活的-App" class="headerlink" title="需要激活的 App"></a>需要激活的 App</h3><ul>
<li>MoneyWiz</li>
<li>MWeb</li>
<li>Sketch</li>
<li>PDF Expert</li>
<li>Downie</li>
</ul>
<h3 id="系统配置"><a href="#系统配置" class="headerlink" title="系统配置"></a>系统配置</h3><h4 id="System-Preferences"><a href="#System-Preferences" class="headerlink" title="System Preferences"></a>System Preferences</h4><ul>
<li><code>General</code> -&gt; <code>SideBar icon size</code>: <code>Small</code></li>
<li><code>General</code> -&gt; <code>Recent items</code>: <code>5</code></li>
<li><code>Desktop &amp; Screen Saver</code> -&gt; <code>Screen Saver</code>: Fliqlo</li>
<li><code>Desktop &amp; Screen Saver</code> -&gt; <code>Start after</code>: <code>5 Minutes</code></li>
<li><code>Dock</code> -&gt; <code>Position on screen</code>: <code>Left</code></li>
<li><code>Dock</code> -&gt; <code>Show recent application in Dock</code>: <code>NO</code></li>
<li><code>Notifications</code>: 对所有 App 进行配置</li>
<li><code>Accessibility</code> -&gt; <code>Pointer Control</code> -&gt; <code>Trackpad Options</code> -&gt; <code>Enable dragging</code>: <code>three finger drag</code></li>
<li><code>Security &amp; Privacy</code> -&gt; <code>General</code> -&gt; <code>Requeire passowrd</code>: <code>5seconds</code></li>
<li><code>Security &amp; Privacy</code> -&gt; <code>FileVault</code>: <code>Turn On</code></li>
<li><code>Security &amp; Privacy</code> -&gt; <code>Firewall</code>: <code>Turn On</code></li>
<li><code>Keyboard</code> -&gt; <code>Text</code> -&gt; <code>Correct spelling automatically</code>: <code>NO</code></li>
<li><code>Keyboard</code> -&gt; <code>Input Sources</code>: 增加小鹤双拼</li>
<li><code>Trackpad</code>: 打开所有手势</li>
<li><code>Displays</code> -&gt; <code>NightShift</code>: <code>Turn On</code></li>
</ul>
<h4 id="Finder"><a href="#Finder" class="headerlink" title="Finder"></a>Finder</h4><ul>
<li><code>General</code> -&gt; <code>New Finder windows show</code>: qiweipeng</li>
<li><code>Tags</code>: 添加到 Favorite Tags</li>
<li><code>SideBar</code> -&gt; <code>Favorites</code>: 仅保留 Applications、Downloads、qiweipeng</li>
</ul>
<h4 id="Safari"><a href="#Safari" class="headerlink" title="Safari"></a>Safari</h4><ul>
<li>首页 -&gt; <code>Show Frequently Visited</code>: <code>Turn Off</code></li>
<li><code>General</code> -&gt; <code>Open &quot;safe&quot; files after downloading</code>: <code>No</code></li>
<li><code>Search</code> -&gt; <code>Search engine</code>: <code>Google</code></li>
<li><code>Advanced</code> -&gt; <code>Show Develop menu in menu bar</code>: <code>Yes</code></li>
<li><code>Extensions</code>: 各个插件具体配置</li>
</ul>
<h4 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h4><ul>
<li>FaceTime -&gt; <code>Ringtone</code>: Hillside</li>
<li>Message -&gt; <code>Message received sound</code>: Bamboo</li>
<li>所有的系统 App 打开 iCloud 账户同步功能</li>
</ul>
<h3 id="Homebrew-1"><a href="#Homebrew-1" class="headerlink" title="Homebrew"></a>Homebrew</h3><p>常用命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ brew list // 安装的软件列表</span><br><span class="line"></span><br><span class="line">$ brew install &lt;name&gt; // 安装某个包</span><br><span class="line"></span><br><span class="line">$ brew uninstall &lt;name&gt; // 卸载安装的软件</span><br><span class="line"></span><br><span class="line">$ brew update // 更新 Homebrew 本身</span><br><span class="line"></span><br><span class="line">$ brew outdated 查看过期软件</span><br><span class="line"></span><br><span class="line">$ brew upgrade &lt;formula&gt; // 更新指定软件</span><br><span class="line"></span><br><span class="line">$ brew pin &lt;formula&gt; 指定某软件保持在当前版本不被更新</span><br><span class="line"></span><br><span class="line">$ brew unpin &lt;formula&gt; 取消某软件保持在当前版本</span><br><span class="line"></span><br><span class="line">$ brew --cache 查看 Homebrew 缓存目录</span><br><span class="line"></span><br><span class="line">// cask 相关</span><br><span class="line"></span><br><span class="line">$ brew install --cask &lt;name&gt; // 使用 cask 安装软件</span><br><span class="line"></span><br><span class="line">$ brew list --cask // 使用 cask 命令安装的应用列表</span><br><span class="line"></span><br><span class="line">$ brew cask uninstall &lt;name&gt; // 卸载使用 cask 命令安装的应用</span><br><span class="line"></span><br><span class="line">$ brew cask search &lt;name&gt; // 查找</span><br></pre></td></tr></table></figure>

<p>避免 Homebrew 自动更新：在 <code>~/.zshrc</code> 文件中写入 <code>export HOMEBREW_NO_AUTO_UPDATE=true</code>。</p>
<p>安装 <a target="_blank" rel="noopener" href="https://github.com/buo/homebrew-cask-upgrade">homebrew-cask-upgrade</a> 方便 cask 应用更新：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ brew tap buo/cask-upgrade // 安装</span><br><span class="line"></span><br><span class="line">$ brew cu -a // 更新所有</span><br><span class="line"></span><br><span class="line">$ brew cu &lt;name&gt; -a 更新指定</span><br></pre></td></tr></table></figure>

<h3 id="node"><a href="#node" class="headerlink" title="node"></a>node</h3><p>常用命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ npm list // 查看当前目录安装的包</span><br><span class="line"></span><br><span class="line">$ npm list -g --depth 0 // 查看本地全局安装过的包</span><br></pre></td></tr></table></figure>

<p>如果需要多版本的 <code>node</code> 则可以通过 <code>brew install nvm</code> 安装 <code>nvm</code>，之后通过 <code>nvm</code> 安装和管理各版本的 <code>node</code>。</p>
<h3 id="nvm"><a href="#nvm" class="headerlink" title="nvm"></a>nvm</h3><p>安装流程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install nvm</span><br></pre></td></tr></table></figure>

<p>在 <code>.zshrc</code> 中写入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export NVM_DIR=&quot;$HOME/.nvm&quot;</span><br><span class="line">[ -s &quot;/usr/local/opt/nvm/nvm.sh&quot; ] &amp;&amp; . &quot;/usr/local/opt/nvm/nvm.sh&quot;  # This loads nvm</span><br></pre></td></tr></table></figure>

<p>安装指定版本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 安装 12.16.3</span><br><span class="line">nvm install v12.16.3</span><br></pre></td></tr></table></figure>

<p>查看：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvm list</span><br></pre></td></tr></table></figure>

<p>如果安装了多个版本，使用如 <code>nvm use v12.16.3</code> 切换到指定版本（重启终端将恢复默认版本），使用如 <code>nvm alias default v12.16.3</code> 设置默认版本。</p>
<h3 id="CocoaPods"><a href="#CocoaPods" class="headerlink" title="CocoaPods"></a>CocoaPods</h3><p>安装 <a target="_blank" rel="noopener" href="https://cocoapods.org/">CocoaPods</a>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo gem install cocoapods</span><br></pre></td></tr></table></figure>

<p>CocoaPods 版本更新：首先使用 <code>$ sudo gem install cocoapods</code> 安装最新版本，之后看哪些被更新了(<code>$ gem list</code>)，再将旧版本卸载掉，比如 <code>$ sudo gem uninstall cocoapods-core -v 1.9.1</code>。</p>
<p>常用命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pod repo // 查看本地关联了哪些仓库源</span><br><span class="line"></span><br><span class="line">pod repo update // 本地仓库更新</span><br><span class="line"></span><br><span class="line">pod repo update &lt;name&gt; // 更新指定的仓库</span><br></pre></td></tr></table></figure>

<h3 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h3><p>参考个人文章<a href="https://qiweipeng.github.io/2018/04/06/git-ssh-key/">《macOS 下 Git 多账号配置，同时管理多个 SSH Key》</a>配置 SSH Key，主要用在 GitHub。</p>
<p>参考个人文章<a href="https://qiweipeng.github.io/2018/04/06/gitignore-ds_store/">《如何设置 Git 全局忽略 .DS_Store 文件》</a>配置全局忽略文件。</p>
<p>参考个人文章<a href="https://qiweipeng.github.io/2018/04/07/some-git-commands/">《记录一些 Git 的命令》</a>对 Git 进行配置，如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// 设置全局的用户名和邮箱</span><br><span class="line">$ git config --global user.name &quot;&lt;name&gt;&quot;</span><br><span class="line">$ git config --global user.email &quot;&lt;email address&gt;&quot;</span><br><span class="line"></span><br><span class="line">// 让 Git 输出语句显示颜色</span><br><span class="line">$ git config --global color.ui true</span><br><span class="line"></span><br><span class="line">// 给常用 Git 命令设置别名，以快捷输入，这个依然是保存在家目录的 .gitconfig 文件中</span><br><span class="line">$ git config --global alias.st status</span><br><span class="line">$ git config --global alias.co checkout</span><br><span class="line">$ git config --global alias.ci commit</span><br><span class="line">$ git config --global alias.br branch</span><br><span class="line">$ git config --global alias.unstage &#x27;reset HEAD&#x27;</span><br><span class="line">$ git config --global alias.last &#x27;log -1&#x27;</span><br><span class="line">$ git config --global alias.lg &quot;log --color --graph --pretty=format:&#x27;%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)&lt;%an&gt;%Creset&#x27; --abbrev-commit&quot;</span><br></pre></td></tr></table></figure>

<h3 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h3><p>使用 <code>brew</code> 安装 <code>openjdk</code> 后，需要关注（使用 <code>brew info openjdk</code> 查看）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">For the system Java wrappers to find this JDK, symlink it with</span><br><span class="line">  sudo ln -sfn /usr/local/opt/openjdk/libexec/openjdk.jdk /Library/Java/JavaVirtualMachines/openjdk.jdk</span><br><span class="line"></span><br><span class="line">openjdk is keg-only, which means it was not symlinked into /usr/local,</span><br><span class="line">because macOS provides similar software and installing this software in</span><br><span class="line">parallel can cause all kinds of trouble.</span><br><span class="line"></span><br><span class="line">If you need to have openjdk first in your PATH, run:</span><br><span class="line">  echo &#x27;export PATH=&quot;/usr/local/opt/openjdk/bin:$PATH&quot;&#x27; &gt;&gt; ~/.zshrc</span><br><span class="line"></span><br><span class="line">For compilers to find openjdk you may need to set:</span><br><span class="line">  export CPPFLAGS=&quot;-I/usr/local/opt/openjdk/include&quot;</span><br></pre></td></tr></table></figure>

<p>同样，安装 <code>openjdk@8</code> 后，需要关注（使用 <code>brew info openjdk@8</code> 查看）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">For the system Java wrappers to find this JDK, symlink it with</span><br><span class="line">  sudo ln -sfn /usr/local/opt/openjdk@8/libexec/openjdk.jdk /Library/Java/JavaVirtualMachines/openjdk-8.jdk</span><br><span class="line"></span><br><span class="line">openjdk@8 is keg-only, which means it was not symlinked into /usr/local,</span><br><span class="line">because this is an alternate version of another formula.</span><br><span class="line"></span><br><span class="line">If you need to have openjdk@8 first in your PATH, run:</span><br><span class="line">  echo &#x27;export PATH=&quot;/usr/local/opt/openjdk@8/bin:$PATH&quot;&#x27; &gt;&gt; ~/.zshrc</span><br><span class="line"></span><br><span class="line">For compilers to find openjdk@8 you may need to set:</span><br><span class="line">  export CPPFLAGS=&quot;-I/usr/local/opt/openjdk@8/include&quot;</span><br></pre></td></tr></table></figure>

<p>（这是直接安装 Oracle JDK 时的配置，OpenJDK 也可以做类似配置，或直接在需要时更改 <code>.zshrc</code> 文件中两个版本的声明顺序）如果安装了多个版本的 Java，可在 <code>.zshrc</code> 中写入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># JDK 8</span><br><span class="line">export JAVA_8_HOME=&quot;/Library/Java/JavaVirtualMachines/jdk1.8.0_271.jdk/Contents/Home&quot;</span><br><span class="line"># JDK 15</span><br><span class="line">export JAVA_15_HOME=&quot;/Library/Java/JavaVirtualMachines/jdk-15.0.1.jdk/Contents/Home&quot;</span><br><span class="line"># 默认JDK 8</span><br><span class="line">export JAVA_HOME=$JAVA_8_HOME</span><br><span class="line"></span><br><span class="line"># alias命令动态切换JDK版本</span><br><span class="line">alias jdk8=&quot;export JAVA_HOME=$JAVA_8_HOME&quot;</span><br><span class="line">alias jdk15=&quot;export JAVA_HOME=$JAVA_15_HOME&quot;</span><br></pre></td></tr></table></figure>

<p>之后可以使用 <code>jdk8</code> 和 <code>jdk15</code> 切换 java 版本。</p>
<h3 id="Xcode"><a href="#Xcode" class="headerlink" title="Xcode"></a>Xcode</h3><h4 id="配置-GitHub"><a href="#配置-GitHub" class="headerlink" title="配置 GitHub"></a>配置 GitHub</h4><p>登录 GitHub：需要配置 Personal access tokens，命名如 <code>Weipeng&#39;s MacBook Pro - Xcode</code>，打开的权限：</p>
<ul>
<li>repo</li>
<li>admin:org</li>
<li>admin:public_key</li>
<li>user</li>
</ul>
<h4 id="代码块"><a href="#代码块" class="headerlink" title="代码块"></a>代码块</h4><p>将备份的<a target="_blank" rel="noopener" href="https://github.com/qiweipeng/CodeSnippets">代码块</a>，即 <code>CodeSnippets</code> 文件夹拖入 <code>~/Library/Developer/Xcode/UserData</code> 目录内。</p>
<h4 id="偏好设置"><a href="#偏好设置" class="headerlink" title="偏好设置"></a>偏好设置</h4><p><code>Preferences</code> 选中 <code>Behaviors</code>，根据 <code>图 - 1</code> 和 <code>图 - 2</code> 进行设置。</p>
<p><img src="https://raw.githubusercontent.com/qiweipeng/images/master/20201010101100.png"></p>
<p>图 - 1: Xcode 偏好设置1</p>
<p><img src="https://raw.githubusercontent.com/qiweipeng/images/master/20201010101109.png"></p>
<p>图 - 2: Xcode 偏好设置2</p>
<h4 id="命令行快捷键"><a href="#命令行快捷键" class="headerlink" title="命令行快捷键"></a>命令行快捷键</h4><p>创建文件 <code>open_terminal.sh</code>，写入代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">if [ -n &quot;$XcodeProjectPath&quot; ]; then</span><br><span class="line">    open -a iTerm &quot;$XcodeProjectPath&quot;/..</span><br><span class="line">else</span><br><span class="line">    open -a iTerm &quot;$XcodeWorkspacePath&quot;/..</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>之后将脚本保存 <code>~/Local/Scripts/</code> 目录下，然后在该目录下执行 <code>chmod +x open_terminal.sh</code> 将脚步设为可执行。</p>
<p>打开 Xcode 的 <code>Preferences</code>，选中 <code>Behaviors</code>，新建并命名为 <code>Open Terminal</code>，快捷键设置为 <code>Control + Command + /</code>，路径选择脚本所在路径。</p>
<p><img src="https://raw.githubusercontent.com/qiweipeng/images/master/20201009190201.png"></p>
<p>图 - 3: 打开命令行脚本设置</p>
<h3 id="Visual-Studio-Code"><a href="#Visual-Studio-Code" class="headerlink" title="Visual Studio Code"></a>Visual Studio Code</h3><p><code>Shift + Command + P</code> 之后找到 <code>Shell Command: Install &quot;code&quot; command in PATH</code>，运行。</p>
<p>登录同步账号：<code>qiweipeng@hotmail.com</code>，登录 Github。</p>
<h3 id="PicGo"><a href="#PicGo" class="headerlink" title="PicGo"></a>PicGo</h3><p>打开[上传前重命名]和[时间戳重命名]。</p>
<p>GitHub 图床设置：</p>
<p><img src="https://raw.githubusercontent.com/qiweipeng/images/master/20201009192119.png"></p>
<p>图 - 4: PicGo 中 GitHub 图床设置</p>
<p>其中需要配置 Personal access tokens，命名如 <code>Weipeng&#39;s MacBook Pro - PicGo</code>，打开的权限：</p>
<ul>
<li>repo</li>
</ul>
<h3 id="Trojan"><a href="#Trojan" class="headerlink" title="Trojan"></a>Trojan</h3><p>User Rules 配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">||notion.so</span><br><span class="line">||*.notion.so</span><br><span class="line">||github.com</span><br><span class="line">||*.github.com</span><br><span class="line">||githubusercontent.com</span><br><span class="line">||*.githubusercontent.com</span><br><span class="line">||dribbble.com</span><br><span class="line">||*.dribbble.com</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://qiweipeng.github.io/2020/06/22/objc-style-guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="齐卫鹏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="齐卫鹏的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/22/objc-style-guide/" class="post-title-link" itemprop="url">Objective-C 代码规范</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-06-22 21:52:54" itemprop="dateCreated datePublished" datetime="2020-06-22T21:52:54+08:00">2020-06-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-26 15:58:51" itemprop="dateModified" datetime="2024-11-26T15:58:51+08:00">2024-11-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文记录一下自己在写 ObjC 代码时遵守的规范，只记录大概，以供查询。</p>
<h2 id="书写顺序"><a href="#书写顺序" class="headerlink" title="书写顺序"></a>书写顺序</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.h</span><br><span class="line">版权</span><br><span class="line">头文件引入（系统/第三方/项目）</span><br><span class="line">NS_ASSUME_NONNULL_BEGIN</span><br><span class="line">@class</span><br><span class="line">宏定义</span><br><span class="line">常量定义</span><br><span class="line">Block 类型定义</span><br><span class="line">枚举</span><br><span class="line">函数声明</span><br><span class="line">协议定义</span><br><span class="line">类定义 @interface</span><br><span class="line">NS_ASSUME_NONNULL_END</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.m</span><br><span class="line">版权</span><br><span class="line">头文件引入（系统/第三方/项目）</span><br><span class="line">宏定义</span><br><span class="line">常量定义</span><br><span class="line">Block 类型定义</span><br><span class="line">枚举</span><br><span class="line">函数</span><br><span class="line">@interface</span><br><span class="line">@implementation</span><br></pre></td></tr></table></figure>

<p>属性关键字顺序：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(nullable, nonatomic, readwrite, getter=method, strong)</span><br></pre></td></tr></table></figure>

<h2 id="规范写法"><a href="#规范写法" class="headerlink" title="规范写法"></a>规范写法</h2><h3 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h3><p>下面是钟颖的代码中定义的静态常量</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">CGFloat</span> kTabBarHeight      = <span class="number">44.0</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">CGFloat</span> kStatusBarHeight   = <span class="number">20.0</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">CGFloat</span> kTableContentInset = <span class="number">200</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// .h</span><br><span class="line">// 字符串常量声明</span><br><span class="line">extern NSString * const &lt;stringName&gt;;</span><br><span class="line"></span><br><span class="line">// .m</span><br><span class="line">// 静态字符串常量</span><br><span class="line">static NSString * const &lt;stringName&gt; = @&quot;&lt;stringName&gt;&quot;;</span><br><span class="line">// 静态常量</span><br><span class="line">static const &lt;Type&gt; &lt;constantName&gt; = &lt;value&gt;;</span><br><span class="line"></span><br><span class="line">// 字符串常量</span><br><span class="line">NSString * const &lt;stringName&gt; = @&quot;&lt;stringName&gt;&quot;;</span><br></pre></td></tr></table></figure>

<h3 id="通知"><a href="#通知" class="headerlink" title="通知"></a>通知</h3><p>下面是 AFNetworking 中通知的写法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// .h</span><br><span class="line">FOUNDATION_EXPORT NSString * const AFNetworkingTaskDidCompleteNotification;</span><br><span class="line">// .m</span><br><span class="line">NSString * const AFNetworkingTaskDidCompleteNotification = @&quot;com.alamofire.networking.task.complete&quot;;</span><br></pre></td></tr></table></figure>

<h2 id="前缀"><a href="#前缀" class="headerlink" title="前缀"></a>前缀</h2><p>前缀需要使用三个字母，如 <code>QWP</code>。</p>
<h3 id="类名"><a href="#类名" class="headerlink" title="类名"></a>类名</h3><p>类名需要添加类前缀。</p>
<h3 id="分类方法"><a href="#分类方法" class="headerlink" title="分类方法"></a>分类方法</h3><p>特别是给系统框架的类增加 Category 的时候，定义的方法需要加小写的类前缀，如 <code>- (NSURL *)sd_currentImageURL;</code>，原因是如果分类方法不小心和类中原有方法或者和其他分类方法同名了，有可能就会覆盖。同一个类的不同分类也可以通过前缀避免方法重名。</p>
<h3 id="Protocol-的名字"><a href="#Protocol-的名字" class="headerlink" title="Protocol 的名字"></a>Protocol 的名字</h3><p>制定代理协议的时候，协议名需要加上制定者的类前缀；但是协议方法是不需要加类前缀的。</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/CodingGuidelines/CodingGuidelines.html">Coding Guidelines for Cocoa</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/github/objective-c-style-guide">GitHub Objective-C Style Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/google/styleguide/blob/gh-pages/objcguide.md">Google Objective-C Style Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/NYTimes/objective-c-style-guide">NYTimes Objective-C Style Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/raywenderlich/objective-c-style-guide#language">The official raywenderlich.com Objective-C style guide</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://qiweipeng.github.io/2020/06/08/cocoapods-private-pods/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="齐卫鹏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="齐卫鹏的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/08/cocoapods-private-pods/" class="post-title-link" itemprop="url">CocoaPods 私有库的创建流程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-06-08 18:21:58" itemprop="dateCreated datePublished" datetime="2020-06-08T18:21:58+08:00">2020-06-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-26 15:58:51" itemprop="dateModified" datetime="2024-11-26T15:58:51+08:00">2024-11-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>可以使用 Github 创建一个私有的 Specs 库，如 <code>https://github.com/qiweipeng/Specs.git</code>，其 ssh 地址是 <code>git@github.com:qiweipeng/Specs.git</code>。</p>
<p>命令行 <code>pod repo add qiweipeng git@github.com:qiweipeng/Specs.git</code> 将这个源拉到本地，本地名称就是命名的 <code>qiweipeng</code>。</p>
<p>使用 <code>pod repo</code> 可以查看本地关联的仓库可以确定否添加成功。</p>
<p>指定一个文件夹，在其中 <code>pod lib create Hello</code> 创建一个命为 <code>Hello</code> 的 Pod 项目，之后一系列选项，配置好即可。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">qiweipeng@Weipengs-MacBook-Air Developer % pod lib create Hello</span><br><span class="line">Cloning `https://github.com/CocoaPods/pod-template.git` into `Hello`.</span><br><span class="line">Configuring Hello template.</span><br><span class="line">security: SecKeychainSearchCopyNext: The specified item could not be found in the keychain.</span><br><span class="line"></span><br><span class="line">------------------------------</span><br><span class="line"></span><br><span class="line">To get you started we need to ask a few questions, this should only take a minute.</span><br><span class="line"></span><br><span class="line">If this is your first time we recommend running through with the guide:</span><br><span class="line"> - https://guides.cocoapods.org/making/using-pod-lib-create.html</span><br><span class="line"> ( hold cmd and click links to open in a browser. )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">What platform do you want to use?? [ iOS / macOS ]</span><br><span class="line"> &gt;</span><br><span class="line">ios</span><br><span class="line">What language do you want to use?? [ Swift / ObjC ]</span><br><span class="line"> &gt; ObjC</span><br><span class="line"></span><br><span class="line">Would you like to include a demo application with your library? [ Yes / No ]</span><br><span class="line"> &gt;</span><br><span class="line">yes</span><br><span class="line">Which testing frameworks will you use? [ Specta / Kiwi / None ]</span><br><span class="line"> &gt; None</span><br><span class="line"></span><br><span class="line">Would you like to do view based testing? [ Yes / No ]</span><br><span class="line"> &gt; No</span><br><span class="line"></span><br><span class="line">What is your class prefix?</span><br><span class="line"> &gt; QWP</span><br><span class="line">security: SecKeychainSearchCopyNext: The specified item could not be found in the keychain.</span><br><span class="line">security: SecKeychainSearchCopyNext: The specified item could not be found in the keychain.</span><br><span class="line">security: SecKeychainSearchCopyNext: The specified item could not be found in the keychain.</span><br><span class="line">security: SecKeychainSearchCopyNext: The specified item could not be found in the keychain.</span><br><span class="line">security: SecKeychainSearchCopyNext: The specified item could not be found in the keychain.</span><br><span class="line">security: SecKeychainSearchCopyNext: The specified item could not be found in the keychain.</span><br><span class="line"></span><br><span class="line">Running pod install on your new library.</span><br><span class="line"></span><br><span class="line">Analyzing dependencies</span><br><span class="line">Downloading dependencies</span><br><span class="line">Installing Hello (0.1.0)</span><br><span class="line">Generating Pods project</span><br><span class="line">Integrating client project</span><br><span class="line"></span><br><span class="line">[!] Please close any current Xcode sessions and use `Hello.xcworkspace` for this project from now on.</span><br><span class="line">Pod installation complete! There is 1 dependency from the Podfile and 1 total pod installed.</span><br><span class="line"></span><br><span class="line"> Ace! you&#x27;re ready to go!</span><br><span class="line"> We will start you off by opening your project in Xcode</span><br><span class="line">  open &#x27;Hello/Example/Hello.xcworkspace&#x27;</span><br><span class="line"></span><br><span class="line">To learn more about the template see `https://github.com/CocoaPods/pod-template.git`.</span><br><span class="line">To learn more about creating a new pod, see `https://guides.cocoapods.org/making/making-a-cocoapod`.</span><br></pre></td></tr></table></figure>

<p>创建好的项目是一个 Git 仓库，里面的 <code>Hello/Classes</code> 文件夹用于放置代码，<code>Hello/Assets</code> 文件夹用于放置图片等素材（这些路径可以通过修改 <code>Hello.podspec</code> 文件进行修改）。外部的 <code>Hello.podspec</code> 是配置文件，另外还有 LICENSE 和 README 等都已经自动创建好。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"># Be sure to run `pod lib lint Hello.podspec&#x27; to ensure this is a</span><br><span class="line"># valid spec before submitting.</span><br><span class="line">#</span><br><span class="line"># Any lines starting with a # are optional, but their use is encouraged</span><br><span class="line"># To learn more about a Podspec see https://guides.cocoapods.org/syntax/podspec.html</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">Pod::Spec.new do |s|</span><br><span class="line">  s.name             = &#x27;Hello&#x27;</span><br><span class="line">  s.version          = &#x27;0.1.0&#x27;</span><br><span class="line">  s.summary          = &#x27;A short description of Hello.&#x27;</span><br><span class="line"></span><br><span class="line"># This description is used to generate tags and improve search results.</span><br><span class="line">#   * Think: What does it do? Why did you write it? What is the focus?</span><br><span class="line">#   * Try to keep it short, snappy and to the point.</span><br><span class="line">#   * Write the description between the DESC delimiters below.</span><br><span class="line">#   * Finally, don&#x27;t worry about the indent, CocoaPods strips it!</span><br><span class="line"></span><br><span class="line">  s.description      = &lt;&lt;-DESC</span><br><span class="line">TODO: Add long description of the pod here.</span><br><span class="line">                       DESC</span><br><span class="line"></span><br><span class="line">  s.homepage         = &#x27;https://github.com/Weipeng Qi/Hello&#x27;</span><br><span class="line">  # s.screenshots     = &#x27;www.example.com/screenshots_1&#x27;, &#x27;www.example.com/screenshots_2&#x27;</span><br><span class="line">  s.license          = &#123; :type =&gt; &#x27;MIT&#x27;, :file =&gt; &#x27;LICENSE&#x27; &#125;</span><br><span class="line">  s.author           = &#123; &#x27;Weipeng Qi&#x27; =&gt; &#x27;qiweipeng@hotmail.com&#x27; &#125;</span><br><span class="line">  s.source           = &#123; :git =&gt; &#x27;https://github.com/Weipeng Qi/Hello.git&#x27;, :tag =&gt; s.version.to_s &#125;</span><br><span class="line">  # s.social_media_url = &#x27;https://twitter.com/&lt;TWITTER_USERNAME&gt;&#x27;</span><br><span class="line"></span><br><span class="line">  s.ios.deployment_target = &#x27;8.0&#x27;</span><br><span class="line"></span><br><span class="line">  s.source_files = &#x27;Hello/Classes/**/*&#x27;</span><br><span class="line">  </span><br><span class="line">  # s.resource_bundles = &#123;</span><br><span class="line">  #   &#x27;Hello&#x27; =&gt; [&#x27;Hello/Assets/*.png&#x27;]</span><br><span class="line">  # &#125;</span><br><span class="line"></span><br><span class="line">  # s.public_header_files = &#x27;Pod/Classes/**/*.h&#x27;</span><br><span class="line">  # s.frameworks = &#x27;UIKit&#x27;, &#x27;MapKit&#x27;</span><br><span class="line">  # s.dependency &#x27;AFNetworking&#x27;, &#x27;~&gt; 2.3&#x27;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p><code>Hello.podspec</code> 文件的具体配置可以参考<a target="_blank" rel="noopener" href="https://guides.cocoapods.org/syntax/podspec.html">官网</a>。</p>
<p>具体的可以设置第三方依赖，可以设置系统 Framework 依赖，可以设置 Info.plist 文件，可以指定具体的图片资源、静态库文件，可以指定具体的平台和版本，也可以配置 <code>compiler_flags</code> 等。</p>
<p>如果是私有库，<code>s.source</code> 可以指定为 <code>git@github.com:qiweipeng/Hello.git</code> 这样的通过 ssh 访问的地址。</p>
<p>代码写好，配置好后，将这个 Git 项目上传到 Gtihub 进行托管，地址和 <code>Hello.podspec</code> 中的应一致。</p>
<p>之后需要验证 <code>Hello.podspec</code> 文件，使用 <code>pod spec lint Hello.podspec</code> 进行联网验证，或使用 <code>pod lib lint Hello.podspec</code> 进行本地验证，建议使用联网验证。</p>
<p>因为创建的 Specs 库在 Github 上是私有的，使用了 SSH；对于 Hello 库，因为也是私有的，在验证时会出现警告说无法访问 <a target="_blank" rel="noopener" href="https://github.com/qiweipeng/Hello%EF%BC%8C%E4%BA%8E%E6%98%AF%E9%AA%8C%E8%AF%81%E5%92%8C%E6%8F%90%E4%BA%A4%E9%83%BD%E5%8A%A0%E4%B8%8A">https://github.com/qiweipeng/Hello，于是验证和提交都加上</a> <code>--allow-warnings</code></p>
<p>这里可选参数有：</p>
<ul>
<li><code>--allow-warnings</code>: 允许警告；</li>
<li><code>--sources=‘master,privateSpecs</code>: 指定源，比如你的私有pod同时依赖了公有库和私有库，你必须指定源才行，因为默认只会去在公有源中查找对应的依赖；</li>
<li><code>--use-libraries</code>: 如果使用了静态库，记得加上它；</li>
</ul>
<p>确定验证通过，然后将 <code>Hello.podspec</code> 文件提交到之前创建的私有 Specs 库中，命令为 <code>pod repo push qiweipeng Hello.podspec</code>，如果 Hello 是私有库，为了通过，则命令为 <code>pod repo push qiweipeng Hello.podspec --allow-warnings</code></p>
<p>成功后就可以正常使用了，不过我们需要在 <code>Podfile</code> 文件中指定源：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">source &#x27;git@github.com:qiweipeng/Specs.git&#x27;</span><br><span class="line">platform :ios, &#x27;9.0&#x27;</span><br><span class="line"></span><br><span class="line">target &#x27;Demo&#x27; do</span><br><span class="line">  use_frameworks!</span><br><span class="line"></span><br><span class="line">  pod &#x27;Hello&#x27;, &#x27;~&gt; 0.1.0&#x27;</span><br><span class="line">  </span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>实际工作中也可以直接将已有项目转成 Pods，只需要加一个配置文件即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ pod spec create Peanut</span><br><span class="line">$ edit Peanut.podspec</span><br><span class="line">$ pod spec lint Peanut.podspec</span><br></pre></td></tr></table></figure>

<p>另外，我们创建的 <code>Pod</code> 也可以不通过任何 <code>Specs</code> 管理而直接使用，我们在其它项目中直接在 <code>Podfile</code> 文件中通过相对路径找到需要的 <code>Pod</code> 的 <code>.podspec</code> 文件即可。如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">platform :ios, &#x27;9.0&#x27;</span><br><span class="line"></span><br><span class="line">target &#x27;Demo&#x27; do</span><br><span class="line">  use_frameworks!</span><br><span class="line"></span><br><span class="line">  pod &#x27;Hello&#x27;, :path =&gt; &#x27;../Hello/&#x27;</span><br><span class="line">  </span><br><span class="line">end</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://qiweipeng.github.io/2020/04/21/objc-block/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="齐卫鹏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="齐卫鹏的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/21/objc-block/" class="post-title-link" itemprop="url">理解 Objective-C Block</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-21 16:48:01" itemprop="dateCreated datePublished" datetime="2020-04-21T16:48:01+08:00">2020-04-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-26 15:58:51" itemprop="dateModified" datetime="2024-11-26T15:58:51+08:00">2024-11-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Block 介绍，截获变量如何实现，__block 修饰符，Block 内存管理，Block 循环引用。<br><code>clang -rewrite-objc -fobjc-arc main.m</code>。    </p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p><code>Block</code> 是 <code>Objective-C</code> 对闭包的实现，<code>Block</code> 是将函数及其上下文封装起来的对象。</p>
<h2 id="Block-的底层实现"><a href="#Block-的底层实现" class="headerlink" title="Block 的底层实现"></a>Block 的底层实现</h2><p>在 <code>main.m</code> 文件中写入如下代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> main(<span class="type">int</span> argc, <span class="keyword">const</span> <span class="type">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">void</span> (^simpleBlock)(<span class="type">void</span>) = ^&#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;This is a block.&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        simpleBlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>命令行输入 <code>clang -rewrite-objc main.m</code> 将其转为 <code>C++</code> 文件 <code>main.cpp</code>。两段关于 <code>Block</code> 的代码编译后如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> (*simpleBlock)(<span class="type">void</span>) = ((<span class="type">void</span> (*)())&amp;__main_block_impl_0((<span class="type">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA));</span><br><span class="line"></span><br><span class="line">((<span class="type">void</span> (*)(__block_impl *))((__block_impl *)simpleBlock)-&gt;FuncPtr)((__block_impl *)simpleBlock); <span class="comment">// 可以看到 Block 的调用最终其实就是去找它的实现 `__block_impl` 中的函数指针 `FuncPtr`，最终就是一个函数调用</span></span><br></pre></td></tr></table></figure>

<p>这里面涉及几个结构：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 代表 Block 对象</span></span><br><span class="line"><span class="keyword">struct</span> __main_block_impl_0 &#123;</span><br><span class="line">  <span class="keyword">struct</span> __block_impl impl; <span class="comment">// 实现</span></span><br><span class="line">  <span class="keyword">struct</span> __main_block_desc_0* Desc; <span class="comment">// 内存管理</span></span><br><span class="line">  __main_block_impl_0(<span class="type">void</span> *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc, <span class="type">int</span> flags=<span class="number">0</span>) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock; <span class="comment">// 代表这是一个栈区 Block</span></span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp; <span class="comment">// 将 __main_block_func_0 作为 Block 具体的实现函数</span></span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125; <span class="comment">// 构造函数</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Block 的实现</span></span><br><span class="line"><span class="keyword">struct</span> __block_impl &#123;</span><br><span class="line">  <span class="type">void</span> *isa; <span class="comment">// 表明 Block 是一个对象</span></span><br><span class="line">  <span class="type">int</span> Flags;</span><br><span class="line">  <span class="type">int</span> Reserved;</span><br><span class="line">  <span class="type">void</span> *FuncPtr; <span class="comment">// 函数指针，指向具体实现</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Block 的实现函数</span></span><br><span class="line"><span class="keyword">static</span> <span class="type">void</span> __main_block_func_0(<span class="keyword">struct</span> __main_block_impl_0 *__cself) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">NSLog</span>((<span class="built_in">NSString</span> *)&amp;__NSConstantStringImpl__var_folders_q4_jm3g73557p74v3ncp13gq3l00000gn_T_main_455ba4_mi_0);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 包含 Block 的内存管理        </span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> __main_block_desc_0 &#123;</span><br><span class="line">  size_t reserved;</span><br><span class="line">  size_t Block_size;</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __main_block_impl_0)&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/qiweipeng/images/master/20201001102501.png"></p>
<p>图 1 - Block 的底层结构</p>
<p>结论：</p>
<ul>
<li><code>Block</code> 是一个对象，因为有 <code>isa</code> 指针；</li>
<li>上述 <code>Block</code> 是一个栈区 <code>Block</code>；</li>
<li><code>Block</code> 的执行本质就是在执行一个函数；</li>
</ul>
<h2 id="Block-值类型临时变量的捕获"><a href="#Block-值类型临时变量的捕获" class="headerlink" title="Block 值类型临时变量的捕获"></a>Block 值类型临时变量的捕获</h2><p>上述代码修改为：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> main(<span class="type">int</span> argc, <span class="keyword">const</span> <span class="type">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> anInteger = <span class="number">5</span>; <span class="comment">// 增加一个临时变量</span></span><br><span class="line">        </span><br><span class="line">        <span class="type">void</span> (^simpleBlock)(<span class="type">void</span>) = ^&#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;Integer is %d&quot;</span>, anInteger); <span class="comment">// Block 中使用这个临时变量。</span></span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        anInteger = <span class="number">10</span>; <span class="comment">// 修改临时变量</span></span><br><span class="line">        </span><br><span class="line">        simpleBlock(); <span class="comment">// 执行后打印结果为 5</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样编译为 <code>C++</code> 后，代码如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> anInteger = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> (*simpleBlock)(<span class="type">void</span>) = ((<span class="type">void</span> (*)())&amp;__main_block_impl_0((<span class="type">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, anInteger)); <span class="comment">// 增加了 anInteger 作为参数</span></span><br><span class="line"></span><br><span class="line">anInteger = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">((<span class="type">void</span> (*)(__block_impl *))((__block_impl *)simpleBlock)-&gt;FuncPtr)((__block_impl *)simpleBlock);</span><br></pre></td></tr></table></figure>

<p>主要的变化是，<code>__main_block_impl_0</code> 的构造函数增加了 <code>anInteger</code> 作为参数传入。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> __main_block_impl_0 &#123;</span><br><span class="line">  <span class="keyword">struct</span> __block_impl impl;</span><br><span class="line">  <span class="keyword">struct</span> __main_block_desc_0* Desc;</span><br><span class="line">  <span class="type">int</span> anInteger; <span class="comment">// 增加了捕获的变量作为成员变量</span></span><br><span class="line">  __main_block_impl_0(<span class="type">void</span> *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc, <span class="type">int</span> _anInteger, <span class="type">int</span> flags=<span class="number">0</span>) : anInteger(_anInteger) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="type">void</span> __main_block_func_0(<span class="keyword">struct</span> __main_block_impl_0 *__cself) &#123;</span><br><span class="line">  <span class="comment">// 增加了一句从 __main_block_impl_0 中获取捕获的变量的步骤，最终函数执行使用的也是捕获后的变量，而不是之前的临时变量</span></span><br><span class="line">  <span class="type">int</span> anInteger = __cself-&gt;anInteger; <span class="comment">// bound by copy</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">NSLog</span>((<span class="built_in">NSString</span> *)&amp;__NSConstantStringImpl__var_folders_q4_jm3g73557p74v3ncp13gq3l00000gn_T_main_62f6c8_mi_0, anInteger);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>结论：</p>
<ul>
<li>Block 会捕获临时变量，即复制一份放入 Block 对象的结构体中，最终 Block 执行是使用的是复制过去的变量，因此被捕获的临时变量即使发生改变，不影响 Block 中捕获的值；</li>
<li>对于值类型的临时变量，Block 是直接捕获的，即直接复制一份进去；</li>
</ul>
<h2 id="Block-关于更多类型变量的截获"><a href="#Block-关于更多类型变量的截获" class="headerlink" title="Block 关于更多类型变量的截获"></a>Block 关于更多类型变量的截获</h2><p>上一部分是关于基本类型的临时变量的截获，就是直接复制一份，那么对于更多类型的变量呢？</p>
<ul>
<li>对于局部变量<ul>
<li>基本数据类型：直接截获该值，就是复制一份；</li>
<li>对象类型：连同对象的所有权修饰符一起截获；</li>
</ul>
</li>
<li>静态局部变量：指针引用；</li>
<li>静态全局变量：不捕获；</li>
<li>全局变量：不捕获；</li>
</ul>
<p><strong>全局变量在整个工程中均有效；静态全局变量即 ObjC 中常常在 <code>@implementation</code> 上面定义的静态变量，它只在定义它的文件内有效；静态局部变量是在某个函数中定义的静态变量，程序只会为它分配一次内存，在函数返回后它不会消失，它的储存和静态全局变量类似，都不会放在栈区，而是在静态区；局部变量存储在栈区，随着函数执行结束内存就会释放。</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> num1 = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="type">int</span> num2 = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> main(<span class="type">int</span> argc, <span class="keyword">const</span> <span class="type">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">static</span> <span class="type">int</span> num3 = <span class="number">30</span>;</span><br><span class="line">        <span class="type">int</span> num4 = <span class="number">40</span>;</span><br><span class="line">        </span><br><span class="line">        __<span class="keyword">unsafe_unretained</span> <span class="type">id</span> obj1 = <span class="literal">nil</span>;</span><br><span class="line">        __<span class="keyword">strong</span> <span class="type">id</span> obj2 = <span class="literal">nil</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="type">void</span> (^simpleBlock)(<span class="type">void</span>) = ^&#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;全局变量%d&quot;</span>, num1);</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;静态全局变量%d&quot;</span>, num2);</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;静态局部变量 %d&quot;</span>, num3);</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;局部变量 %d&quot;</span>, num4);</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;对象1 %@&quot;</span>, obj1);</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;对象2 %@&quot;</span>, obj2);</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        simpleBlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用命令 <code>clang -rewrite-objc -fobjc-arc main.m</code> 编译成 <code>C++</code> 代码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">// 全局变量和静态全局变量都是在函数外定义，Block 不进行捕获而是直接可以拿到</span><br><span class="line">int num1 = 10;</span><br><span class="line">static int num2 = 20;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">struct __main_block_impl_0 &#123;</span><br><span class="line">  struct __block_impl impl;</span><br><span class="line">  struct __main_block_desc_0* Desc;</span><br><span class="line">  int *num3; // 局部静态变量通过指针方式捕获</span><br><span class="line">  int num4; // 局部变量直接捕获其值</span><br><span class="line">  __unsafe_unretained id obj1; // 对于对象，会包含其所有权修饰符一起捕获</span><br><span class="line">  __strong id obj2;</span><br><span class="line">  __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int *_num3, int _num4, __unsafe_unretained id _obj1, __strong id _obj2, int flags=0) : num3(_num3), num4(_num4), obj1(_obj1), obj2(_obj2) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">static void __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</span><br><span class="line">  int *num3 = __cself-&gt;num3; // bound by copy</span><br><span class="line">  int num4 = __cself-&gt;num4; // bound by copy</span><br><span class="line">  __unsafe_unretained id obj1 = __cself-&gt;obj1; // bound by copy</span><br><span class="line">  __strong id obj2 = __cself-&gt;obj2; // bound by copy</span><br><span class="line"></span><br><span class="line">            NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_q4_jm3g73557p74v3ncp13gq3l00000gn_T_main_3341c1_mi_0, num1);</span><br><span class="line">            NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_q4_jm3g73557p74v3ncp13gq3l00000gn_T_main_3341c1_mi_1, num2);</span><br><span class="line">            NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_q4_jm3g73557p74v3ncp13gq3l00000gn_T_main_3341c1_mi_2, (*num3));</span><br><span class="line">            NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_q4_jm3g73557p74v3ncp13gq3l00000gn_T_main_3341c1_mi_3, num4);</span><br><span class="line">            NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_q4_jm3g73557p74v3ncp13gq3l00000gn_T_main_3341c1_mi_4, obj1);</span><br><span class="line">            NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_q4_jm3g73557p74v3ncp13gq3l00000gn_T_main_3341c1_mi_5, obj2);</span><br><span class="line">        &#125;</span><br><span class="line">static void __main_block_copy_0(struct __main_block_impl_0*dst, struct __main_block_impl_0*src) &#123;_Block_object_assign((void*)&amp;dst-&gt;obj1, (void*)src-&gt;obj1, 3/*BLOCK_FIELD_IS_OBJECT*/);_Block_object_assign((void*)&amp;dst-&gt;obj2, (void*)src-&gt;obj2, 3/*BLOCK_FIELD_IS_OBJECT*/);&#125;</span><br><span class="line"></span><br><span class="line">static void __main_block_dispose_0(struct __main_block_impl_0*src) &#123;_Block_object_dispose((void*)src-&gt;obj1, 3/*BLOCK_FIELD_IS_OBJECT*/);_Block_object_dispose((void*)src-&gt;obj2, 3/*BLOCK_FIELD_IS_OBJECT*/);&#125;</span><br><span class="line"></span><br><span class="line">static struct __main_block_desc_0 &#123;</span><br><span class="line">  size_t reserved;</span><br><span class="line">  size_t Block_size;</span><br><span class="line">  void (*copy)(struct __main_block_impl_0*, struct __main_block_impl_0*);</span><br><span class="line">  void (*dispose)(struct __main_block_impl_0*);</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; 0, sizeof(struct __main_block_impl_0), __main_block_copy_0, __main_block_dispose_0&#125;;</span><br><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">    /* @autoreleasepool */ &#123; __AtAutoreleasePool __autoreleasepool; </span><br><span class="line"></span><br><span class="line">        static int num3 = 30;</span><br><span class="line">        int num4 = 40;</span><br><span class="line"></span><br><span class="line">        __attribute__((objc_ownership(none))) id obj1 = __null;</span><br><span class="line">        __attribute__((objc_ownership(strong))) id obj2 = __null;</span><br><span class="line"></span><br><span class="line">        void (*simpleBlock)(void) = ((void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA, &amp;num3, num4, obj1, obj2, 570425344));</span><br><span class="line"></span><br><span class="line">        ((void (*)(__block_impl *))((__block_impl *)simpleBlock)-&gt;FuncPtr)((__block_impl *)simpleBlock);</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="block-修饰符"><a href="#block-修饰符" class="headerlink" title="__block 修饰符"></a>__block 修饰符</h2><p>默认情况下，被捕获的局部变量在 <code>Block</code> 内部是无法被赋值的，如果赋值编译器会报错。默认情况下，被捕获的局部变量在 <code>Block</code> 的实现结构体中是一个成员变量。</p>
<p><strong><code>__block</code> 修饰符的作用是，将这个临时变量变成一个对象存储起来。</strong></p>
<p>还是上述对基本类型的临时变量的捕获的例子，我们加上 <code>__block</code> 修饰符：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> main(<span class="type">int</span> argc, <span class="keyword">const</span> <span class="type">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        </span><br><span class="line">        __block <span class="type">int</span> anInteger = <span class="number">5</span>; <span class="comment">// 加上 __block 修饰符</span></span><br><span class="line">        </span><br><span class="line">        <span class="type">void</span> (^simpleBlock)(<span class="type">void</span>) = ^&#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;Integer is %d&quot;</span>, anInteger);</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        anInteger = <span class="number">10</span>;</span><br><span class="line">        </span><br><span class="line">        simpleBlock(); <span class="comment">// 加上 __block 修饰符后，打印结果变成了 10</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译后的结果为：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 针对 anInteger 变量专门创建了一个结构体</span></span><br><span class="line"><span class="keyword">struct</span> __Block_byref_anInteger_0 &#123;</span><br><span class="line">  <span class="type">void</span> *__isa; <span class="comment">// 拥有 isa</span></span><br><span class="line">__Block_byref_anInteger_0 *__forwarding; <span class="comment">// 转发指针，栈区 Block 在 copy 之前都是指向自己</span></span><br><span class="line"> <span class="type">int</span> __flags;</span><br><span class="line"> <span class="type">int</span> __size;</span><br><span class="line"> <span class="type">int</span> anInteger; <span class="comment">// 这里存储变量的值</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> __main_block_impl_0 &#123;</span><br><span class="line">  <span class="keyword">struct</span> __block_impl impl;</span><br><span class="line">  <span class="keyword">struct</span> __main_block_desc_0* Desc;</span><br><span class="line">  __Block_byref_anInteger_0 *anInteger; <span class="comment">// by ref // 之前是直接捕获，现在变成了一个结构体指针</span></span><br><span class="line">  __main_block_impl_0(<span class="type">void</span> *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc, __Block_byref_anInteger_0 *_anInteger, <span class="type">int</span> flags=<span class="number">0</span>) : anInteger(_anInteger-&gt;__forwarding) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>结论：</p>
<ul>
<li>临时变量被捕获后在 <code>Block</code> 内部无法被修改，因为是值类型</li>
<li>静态变量和全局变量都不涉及 <code>__block</code> 修饰符</li>
<li>加上 <code>__block</code> 修饰符后，变量变成对象存储起来，并且在 <code>Block</code> 内外进行修改都是在操作这个对象。</li>
</ul>
<h3 id="forwarding"><a href="#forwarding" class="headerlink" title="__forwarding"></a>__forwarding</h3><p>继续上面的例子，我们查看 <code>__main_block_func_0</code> 函数，也就是 <code>Block</code> 的具体函数实现。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">void</span> __main_block_func_0(<span class="keyword">struct</span> __main_block_impl_0 *__cself) &#123;</span><br><span class="line">  __Block_byref_anInteger_0 *anInteger = __cself-&gt;anInteger; <span class="comment">// bound by ref</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">NSLog</span>((<span class="built_in">NSString</span> *)&amp;__NSConstantStringImpl__var_folders_q4_jm3g73557p74v3ncp13gq3l00000gn_T_main_5fc99a_mi_0, (anInteger-&gt;__forwarding-&gt;anInteger));</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，使用 <code>NSLog()</code> 打印这个变量时，并不是直接从 <code>__Block_byref_anInteger_0</code> 结构体中取出 <code>anInteger</code>，而是通过它的 <code>__forwarding</code> 绕了一下，即 <code>anInteger-&gt;__forwarding-&gt;anInteger</code>。<br>这个例子中，<code>Block</code> 就是一个栈区的 <code>Block</code>，这个 <code>__forwarding</code> 就是指向本身栈区创建的这个结构体，因此不管直接取值还是通过指针取值最终都是一样的。</p>
<h2 id="Block-的内存管理"><a href="#Block-的内存管理" class="headerlink" title="Block 的内存管理"></a>Block 的内存管理</h2><p><code>Block</code> 分三种类型，分别是栈区 <code>Block</code>、堆区 <code>Block</code> 和全局 <code>Block</code>。</p>
<table>
<thead>
<tr>
<th>Block类别</th>
<th>源</th>
<th>Copy结果</th>
</tr>
</thead>
<tbody><tr>
<td>_NSConcreteStackBlock</td>
<td>栈</td>
<td>堆</td>
</tr>
<tr>
<td>_NSConcreteMallocBlock</td>
<td>堆</td>
<td>增加引用计数</td>
</tr>
<tr>
<td>_NSConcreteGlobalBlock</td>
<td>数据区</td>
<td>什么也不做</td>
</tr>
</tbody></table>
<p>关于 <code>copy</code> 操作，当栈区 <code>Block</code> 拷贝一份到堆区后，会产生一份一样的 <code>Block</code> 在堆区，唯一不同的是，<code>__block</code> 修饰的变量对象在拷贝一份后，堆区的那个其 <code>__forwarding</code> 依旧指向自己，但是栈区的这个其 <code>__forwarding</code> 指针指向的是对应的堆区的那个对象。</p>
<p>因此，<code>__forwarding</code> 保证了不管是否有 <code>copy</code> 操作，最终操作的 <code>__block</code> 变量都是同一个。</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Blocks/Articles/00_Introduction.html#//apple_ref/doc/uid/TP40007502-CH1-SW1">Blocks Programming Topics</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ProgrammingWithObjectiveC/WorkingwithBlocks/WorkingwithBlocks.html#//apple_ref/doc/uid/TP40011210-CH8-SW1">Working with Blocks</a></li>
<li><a target="_blank" rel="noopener" href="http://fuckingblocksyntax.com/">How Do I Declare A Block in Objective-C?</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/abc649395594/article/details/47086751">你真的理解__block修饰符的原理么？</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/5a309c2751882531ba10ed9d">对 Strong-Weak Dance的思考</a></li>
<li><a target="_blank" rel="noopener" href="https://draveness.me/block-retain-object/">iOS 中的 block 是如何持有对象的</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/5a309c1b6fb9a04517052f19">OC与Swift闭包对比总结</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/5add619f6fb9a07ac90cced6">iOS中Block的用法，示例，应用场景，与底层原理解析</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://qiweipeng.github.io/2020/04/14/runtime-api/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="齐卫鹏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="齐卫鹏的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/14/runtime-api/" class="post-title-link" itemprop="url">Objective-C Runtime 之四 常用 API</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-14 19:41:28" itemprop="dateCreated datePublished" datetime="2020-04-14T19:41:28+08:00">2020-04-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-26 15:58:51" itemprop="dateModified" datetime="2024-11-26T15:58:51+08:00">2024-11-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="objc-getClass"><a href="#objc-getClass" class="headerlink" title="objc_getClass"></a>objc_getClass</h2><p>通过字符串获取某一个类。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过字符串获取到这个类然后生成一个实例。</span></span><br><span class="line">Class cls = objc_getClass(<span class="string">&quot;Person&quot;</span>);</span><br><span class="line">Person *p = [cls new];</span><br><span class="line">[p hello];</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>objc_getMetaClass</code> 是通过一个字符串获取元类。<br><code>object_getClass</code> 是通过一个对象获取其 <code>isa</code>。</p>
</blockquote>
<h2 id="class-getName"><a href="#class-getName" class="headerlink" title="class_getName"></a>class_getName</h2><p>通过一个类获取类名字符串。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;%s&quot;</span>, class_getName([Person <span class="keyword">class</span>]));</span><br></pre></td></tr></table></figure>

<h2 id="class-copyIvarList"><a href="#class-copyIvarList" class="headerlink" title="class_copyIvarList"></a>class_copyIvarList</h2><p><code>class_copyIvarList</code> 可以获取变量列表，之后 <code>ivar_getName</code> 可以获得变量名，<code>ivar_getTypeEncoding</code> 可以获得变量类型。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> outCount = <span class="number">0</span>;</span><br><span class="line">Ivar *ivarList = class_copyIvarList([Person <span class="keyword">class</span>], &amp;outCount);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>; i &lt; outCount; i++) &#123;</span><br><span class="line">    Ivar ivar = ivarList[i];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%s&quot;</span>, ivar_getName(ivar));</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%s&quot;</span>, ivar_getTypeEncoding(ivar));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> _name</span></span><br><span class="line"><span class="comment"> @&quot;NSString&quot;</span></span><br><span class="line"><span class="comment"> _age</span></span><br><span class="line"><span class="comment"> q</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<h2 id="class-copyPropertyList"><a href="#class-copyPropertyList" class="headerlink" title="class_copyPropertyList"></a>class_copyPropertyList</h2><p><code>class_copyPropertyList</code> 用于获取属性列表。<code>property_getName</code> 用于获取属性名，<code>property_getAttributes</code> 用于获取属性内容。</p>
<p>其中，关于属性中编码含义参见 <a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtPropertyIntrospection.html#//apple_ref/doc/uid/TP40008048-CH101-SW24">Declared Properties</a></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> outCount = <span class="number">0</span>;</span><br><span class="line">objc_property_t *propertyList = class_copyPropertyList([Person <span class="keyword">class</span>], &amp;outCount);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>; i &lt; outCount; i++) &#123;</span><br><span class="line">    objc_property_t p = propertyList[i];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%s&quot;</span>, property_getName(p));</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%s&quot;</span>, property_getAttributes(p));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> name</span></span><br><span class="line"><span class="comment"> T@&quot;NSString&quot;,C,N,V_name</span></span><br><span class="line"><span class="comment"> age</span></span><br><span class="line"><span class="comment"> Tq,N,V_age</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<h2 id="class-copyMethodList"><a href="#class-copyMethodList" class="headerlink" title="class_copyMethodList"></a>class_copyMethodList</h2><p><code>class_copyMethodList</code> 用于获取方法列表</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> outCount = <span class="number">0</span>;</span><br><span class="line">Method *methodList = class_copyMethodList([Person <span class="keyword">class</span>], &amp;outCount);</span><br><span class="line"> </span><br><span class="line"><span class="built_in">NSMutableDictionary</span> *dict = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>; i &lt; outCount; i++) &#123;</span><br><span class="line">    Method method = methodList[i];</span><br><span class="line">    SEL sel = method_getName(method);</span><br><span class="line">    dict[<span class="built_in">NSStringFromSelector</span>(sel)] = [<span class="built_in">NSString</span> stringWithUTF8String:method_getTypeEncoding(method)];</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, dict);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> &#123;</span></span><br><span class="line"><span class="comment"> &quot;.cxx_destruct&quot; = &quot;v16@0:8&quot;;</span></span><br><span class="line"><span class="comment">    age = &quot;q16@0:8&quot;;</span></span><br><span class="line"><span class="comment">    &quot;helloTo:&quot; = &quot;v24@0:8@16&quot;;</span></span><br><span class="line"><span class="comment">    name = &quot;@16@0:8&quot;;</span></span><br><span class="line"><span class="comment">    &quot;setAge:&quot; = &quot;v24@0:8q16&quot;;</span></span><br><span class="line"><span class="comment">    &quot;setName:&quot; = &quot;v24@0:8@16&quot;;</span></span><br><span class="line"><span class="comment">    walk = &quot;v16@0:8&quot;;</span></span><br><span class="line"><span class="comment"> &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="class-copyProtocolList"><a href="#class-copyProtocolList" class="headerlink" title="class_copyProtocolList"></a>class_copyProtocolList</h2><p><code>class_copyProtocolList</code> 用于获取协议列表。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__<span class="keyword">unsafe_unretained</span> Protocol **protocolList = class_copyProtocolList([Person <span class="keyword">class</span>], &amp;outCount);</span><br></pre></td></tr></table></figure>

<h2 id="class-addIvar"><a href="#class-addIvar" class="headerlink" title="class_addIvar"></a>class_addIvar</h2><p><code>class_addIvar</code> 用于动态添加变量。一个编译好的类是无法添加变量的，但是我们是动态创建并注册一个类，在注册之前为其动态添加变量。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 给类分配空间</span></span><br><span class="line">Class Game = objc_allocateClassPair([<span class="built_in">NSObject</span> <span class="keyword">class</span>], <span class="string">&quot;Game&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加变量</span></span><br><span class="line"><span class="type">BOOL</span> isAdded = class_addIvar(Game, <span class="string">&quot;name&quot;</span>, <span class="keyword">sizeof</span>(<span class="built_in">NSString</span> *), log2(<span class="keyword">sizeof</span>(<span class="built_in">NSString</span> *)), <span class="keyword">@encode</span>(<span class="built_in">NSString</span> *));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册类</span></span><br><span class="line">objc_registerClassPair(Game);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isAdded) &#123;</span><br><span class="line">    <span class="type">id</span> game = [[Game alloc] init];</span><br><span class="line">    [game setValue:<span class="string">@&quot;mario&quot;</span> forKey:<span class="string">@&quot;name&quot;</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, game);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, [game valueForKey:<span class="string">@&quot;name&quot;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt;Game: 0x1006aaba0&gt;</span></span><br><span class="line"><span class="comment">// mario</span></span><br></pre></td></tr></table></figure>

<h2 id="class-addMethod"><a href="#class-addMethod" class="headerlink" title="class_addMethod"></a>class_addMethod</h2><p>即使是以及编译好的类，也可以动态添加方法。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 获取方法</span></span><br><span class="line">Method method = class_getInstanceMethod([Person <span class="keyword">class</span>], <span class="keyword">@selector</span>(hello));</span><br><span class="line"><span class="comment">// 获取方法实现</span></span><br><span class="line">IMP methodIMP = method_getImplementation(method);</span><br><span class="line"><span class="comment">// 获取方法类型（即返回值、参数类型）</span></span><br><span class="line"><span class="keyword">const</span> <span class="type">char</span> *types = method_getTypeEncoding(method);</span><br><span class="line"></span><br><span class="line">class_addMethod([Animal <span class="keyword">class</span>], <span class="keyword">@selector</span>(hi), methodIMP, types);</span><br><span class="line"></span><br><span class="line">Animal *a = [Animal new];</span><br><span class="line">[a hi];</span><br></pre></td></tr></table></figure>

<p>本例将 <code>Person</code> 类的一个方法添加给了 <code>Animal</code> 类中。</p>
<h2 id="method-exchangeImplementations"><a href="#method-exchangeImplementations" class="headerlink" title="method_exchangeImplementations"></a>method_exchangeImplementations</h2><p><code>method_exchangeImplementations</code> 用于交换两个方法的实现。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Method method1 = class_getInstanceMethod([Person <span class="keyword">class</span>], <span class="keyword">@selector</span>(hello));</span><br><span class="line"></span><br><span class="line">Method method2 = class_getInstanceMethod([Person <span class="keyword">class</span>], <span class="keyword">@selector</span>(walk));</span><br><span class="line"></span><br><span class="line">method_exchangeImplementations(method1, method2);</span><br><span class="line"></span><br><span class="line">Person *p = [Person new];</span><br><span class="line">[p hello];</span><br><span class="line">[p walk];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Walk!</span></span><br><span class="line"><span class="comment">// Hello!</span></span><br></pre></td></tr></table></figure>

<p>本例我们交换了两个方法的实现，最终调用 <code>hello</code> 输出 <code>Walk!</code>，调用 <code>walk</code> 输出 <code>Hello!</code>。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://qiweipeng.github.io/2020/04/14/runtime-messaging/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="齐卫鹏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="齐卫鹏的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/14/runtime-messaging/" class="post-title-link" itemprop="url">Objective-C Runtime 之三 理解消息机制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-14 19:34:42" itemprop="dateCreated datePublished" datetime="2020-04-14T19:34:42+08:00">2020-04-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-26 15:58:51" itemprop="dateModified" datetime="2024-11-26T15:58:51+08:00">2024-11-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>ObjC 中的方法调用是一个传递消息的过程，它不是直接去调用一个函数，而是通过 <code>selector</code> 去查找 <code>IMP</code> 的过程，最终查找到函数指针，然后执行具体函数实现；如果没有找到函数实现，还会继续执行消息转发流程，最后仍没有查找到函数实现，就报错崩溃。</p>
<h2 id="objc-msgSend-函数"><a href="#objc-msgSend-函数" class="headerlink" title="objc_msgSend 函数"></a>objc_msgSend 函数</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// message.h</span></span><br><span class="line"></span><br><span class="line">OBJC_EXPORT <span class="type">id</span> _Nullable</span><br><span class="line">objc_msgSend(<span class="type">id</span> _Nullable <span class="keyword">self</span>, SEL _Nonnull op, ...)</span><br><span class="line">    OBJC_AVAILABLE(<span class="number">10.0</span>, <span class="number">2.0</span>, <span class="number">9.0</span>, <span class="number">1.0</span>, <span class="number">2.0</span>);</span><br></pre></td></tr></table></figure>

<p>ObjC 通常的方法调用实质上就是调用 <code>objc_msgSend</code> 函数。</p>
<p>如下代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Person *olivia = [[Person alloc] init];</span><br><span class="line">[olivia sayHi];</span><br></pre></td></tr></table></figure>

<p>使用命令 <code>clang -rewrite-objc main.m</code> 编译成 C++ 代码后如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Person *olivia = ((Person *(*)(id, SEL))(<span class="type">void</span> *)objc_msgSend)((id)((Person *(*)(id, SEL))(<span class="type">void</span> *)objc_msgSend)((id)<span class="built_in">objc_getClass</span>(<span class="string">&quot;Person&quot;</span>), <span class="built_in">sel_registerName</span>(<span class="string">&quot;alloc&quot;</span>)), <span class="built_in">sel_registerName</span>(<span class="string">&quot;init&quot;</span>));</span><br><span class="line">((<span class="built_in">void</span> (*)(id, SEL))(<span class="type">void</span> *)objc_msgSend)((id)olivia, <span class="built_in">sel_registerName</span>(<span class="string">&quot;sayHi&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>如果是使用 <code>super</code> 关键字，则调用的是 <code>objc_msgSendSuper</code> 函数。</p>
<h2 id="消息发送流程"><a href="#消息发送流程" class="headerlink" title="消息发送流程"></a>消息发送流程</h2><ol>
<li>检查 <code>selector</code> 是否要忽略，比如自动引用计数下 <code>retain</code>、<code>release</code> 方法将会被忽略。</li>
<li>检查 <code>target</code> 是否为 <code>nil</code>，如果为 <code>nil</code> 则直接返回 <code>nil</code>。</li>
<li>通过 <code>selector</code> 查找具体的 <code>IMP</code>，首先查找缓存列表。具体方法就是通过一个哈希函数将 <code>SEL</code> 映射到指定的 <code>bucket_t</code> 在数组中的位置。</li>
<li>如果换成列表没有，开始查找方法列表。对于已排序好的列表，采用 <code>二分查找法</code> 进行查找。对于没有排序好的列表，就进行遍历查找。如果查找到了会将对应的 <code>IMP</code> 放入方法缓存列表中。</li>
<li>如果方法列表没有，逐级查找父类缓存列表和方法列表，最终直到查找 <code>NSObject</code> 类。</li>
<li>进入动态方法解析、消息转发流程。</li>
</ol>
<h2 id="消息转发"><a href="#消息转发" class="headerlink" title="消息转发"></a>消息转发</h2><h3 id="动态方法解析"><a href="#动态方法解析" class="headerlink" title="动态方法解析"></a>动态方法解析</h3><p>如果给一个对象发送消息，该对象并没有对应的方法实现，那么程序不会直接崩溃，首先会进入动态方法解析的过程。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NSObject.h</span></span><br><span class="line"></span><br><span class="line">+ (<span class="type">BOOL</span>)resolveClassMethod:(SEL)sel OBJC_AVAILABLE(<span class="number">10.5</span>, <span class="number">2.0</span>, <span class="number">9.0</span>, <span class="number">1.0</span>, <span class="number">2.0</span>);</span><br><span class="line">+ (<span class="type">BOOL</span>)resolveInstanceMethod:(SEL)sel OBJC_AVAILABLE(<span class="number">10.5</span>, <span class="number">2.0</span>, <span class="number">9.0</span>, <span class="number">1.0</span>, <span class="number">2.0</span>);</span><br></pre></td></tr></table></figure>

<p>动态方法解析核心是上述两个方法（都是 <code>NSObject</code> 的类方法），分别解决类方法和实例方法。当对象没有对应方法实现的时候，上述方法就是第一个补救措施。</p>
<p>对于 <code>@dynamic</code> 关键字到属性，系统不提供 <code>setter</code> 和 <code>getter</code> 方法实现，就需要在动态方法解析中为其动态添加两个方法实现。</p>
<h3 id="动态添加方法"><a href="#动态添加方法" class="headerlink" title="动态添加方法"></a>动态添加方法</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> playIMP(<span class="type">id</span> <span class="keyword">self</span>, SEL _cmd) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;Game Start!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> playWithTypeIMP(<span class="type">id</span> <span class="keyword">self</span>, SEL _cmd, GameType type) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">        <span class="keyword">case</span> GameTypeOne:</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;Game Type One Start!&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> GameTypeTwo:</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;Game Type Two Start!&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> GameTypeThree:</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;Game Type Three Start!&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="type">BOOL</span>)resolveInstanceMethod:(SEL)sel &#123;</span><br><span class="line">    <span class="keyword">if</span> (sel == <span class="keyword">@selector</span>(play)) &#123;</span><br><span class="line">        class_addMethod(<span class="keyword">self</span>, sel, (IMP)playIMP, <span class="string">&quot;v@:&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sel == <span class="keyword">@selector</span>(playWith:)) &#123;</span><br><span class="line">        class_addMethod(<span class="keyword">self</span>, sel, (IMP)playWithTypeIMP, <span class="string">&quot;v@:i&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> [<span class="variable language_">super</span> resolveInstanceMethod:sel];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>resolveInstanceMethod</code> 方法中，使用 <code>class_addMethod</code> 函数为指定的类动态添加方法。</p>
<h3 id="消息重定向"><a href="#消息重定向" class="headerlink" title="消息重定向"></a>消息重定向</h3><p>如果 <code>resolveInstanceMethod:</code> 方法中没有找到方法实现，将会进入第二个补救措施，就是消息重定向 <code>forwardingTargetForSelector:</code>，这个方法可以将消息的接受者更换为其他对象。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">id</span>)forwardingTargetForSelector:(SEL)aSelector &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (aSelector == <span class="keyword">@selector</span>(play)) &#123;</span><br><span class="line">        <span class="keyword">return</span> [SecondGame new]; <span class="comment">// 返回一个其他的对象，如果这个对象存在这个方法实现的话</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="转发"><a href="#转发" class="headerlink" title="转发"></a>转发</h3><p>如果上述方法返回 nil，则会进入到最后一个补救方法中，即消息转发流程。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)aSelector &#123;</span><br><span class="line">    <span class="keyword">if</span> (aSelector == <span class="keyword">@selector</span>(play)) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 这里返回方法签名</span></span><br><span class="line">        <span class="keyword">return</span> [<span class="built_in">NSMethodSignature</span> signatureWithObjCTypes:<span class="string">&quot;v@:&quot;</span>];</span><br><span class="line">        <span class="comment">// 上面是直接写，下面是返回一个方法的 types，都可以</span></span><br><span class="line">        <span class="comment">// return [self methodSignatureForSelector:@selector(anotherPlay)];</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> [<span class="variable language_">super</span> methodSignatureForSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用另一个方法实现做代替</span></span><br><span class="line">    <span class="keyword">if</span> (anInvocation.selector == <span class="keyword">@selector</span>(play)) &#123;</span><br><span class="line">        anInvocation.selector = <span class="keyword">@selector</span>(anotherPlay);</span><br><span class="line">        <span class="comment">// 也可以是其他类，看实际情况。</span></span><br><span class="line">        [anInvocation invokeWithTarget:<span class="keyword">self</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终这里可以实现，让原本的消息接受者去执行一个其他的方法，也可以更好消息接受者，去执行一个指定的方法，都是可以的。</p>
<h2 id="模拟继承"><a href="#模拟继承" class="headerlink" title="模拟继承"></a>模拟继承</h2><p>使用消息转发的原理，可以实现模拟多继承，我们定义一个 <code>Person</code> 类和一个 <code>Machine</code> 类，并定义一个 <code>Robot</code> 类对前两个类进行继承。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Person</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)hello;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)hello &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;Hello World!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Machine</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Machine</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)lubricate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Machine</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)lubricate &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;Lubricate.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Robot</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Robot</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)hello;</span><br><span class="line">- (<span class="type">void</span>)lubricate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="string">&quot;Robot.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="string">&quot;Person.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="string">&quot;Machine.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Robot</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) Person *person;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) Machine *machine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Robot</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="variable language_">super</span> init];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.person = [[Person alloc] init];</span><br><span class="line">        <span class="keyword">self</span>.machine = [[Machine alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">id</span>)forwardingTargetForSelector:(SEL)aSelector &#123;</span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.person respondsToSelector:aSelector]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.person;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([<span class="keyword">self</span>.machine respondsToSelector:aSelector]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.machine;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="variable language_">super</span> forwardingTargetForSelector:aSelector];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://qiweipeng.github.io/2020/04/14/runtime-class-and-object/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="齐卫鹏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="齐卫鹏的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/14/runtime-class-and-object/" class="post-title-link" itemprop="url">Objective-C Runtime 之二 理解类和对象</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-14 19:33:20" itemprop="dateCreated datePublished" datetime="2020-04-14T19:33:20+08:00">2020-04-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-26 15:58:51" itemprop="dateModified" datetime="2024-11-26T15:58:51+08:00">2024-11-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="理解常用数据结构"><a href="#理解常用数据结构" class="headerlink" title="理解常用数据结构"></a>理解常用数据结构</h2><p>观察 <code>NSObject</code> 类的结构：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">OBJC_AVAILABLE(<span class="number">10.0</span>, <span class="number">2.0</span>, <span class="number">9.0</span>, <span class="number">1.0</span>, <span class="number">2.0</span>)</span><br><span class="line">OBJC_ROOT_CLASS</span><br><span class="line">OBJC_EXPORT</span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> &lt;<span class="title">NSObject</span>&gt; </span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> clang diagnostic push</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> clang diagnostic ignored <span class="string">&quot;-Wobjc-interface-ivars&quot;</span></span></span><br><span class="line">    Class isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> clang diagnostic pop</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，<code>NSObject</code> 类遵守同名的 <code>NSObject</code> 协议，其类的内部拥有唯一的成员变量 <code>isa</code>。<code>isa</code> 是 <code>Class</code> 类型。</p>
<h3 id="objc-class"><a href="#objc-class" class="headerlink" title="objc_class"></a>objc_class</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Object.mm</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_class *Class;</span><br></pre></td></tr></table></figure>

<p><code>Class</code> 就是 ObjC 中类的实现，本质上是一个结构体指针，这个结构体是 <code>objc_class</code>。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc-runtime-new.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> objc_class : objc_object &#123;</span><br><span class="line">    <span class="comment">// Class ISA;</span></span><br><span class="line">    Class superclass; <span class="comment">// 父类</span></span><br><span class="line">    cache_t cache;             <span class="comment">// formerly cache pointer and vtable // 方法缓存</span></span><br><span class="line">    class_data_bits_t bits;    <span class="comment">// class_rw_t * plus custom rr/alloc flags // 类信息，包括变量、属性、方法等</span></span><br><span class="line"></span><br><span class="line">    class_rw_t *data() <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> bits.data();</span><br><span class="line">    &#125; <span class="comment">// 把类信息中的可读写部分暴露出来</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>上述代码总结如下内容：</p>
<ul>
<li><code>objc_class</code> 继承自 <code>objc_object</code>，也就是说，类本质上也是一个对象，称为类对象。</li>
<li><code>Class superclass</code> 类对象拥有继承体系。</li>
<li><code>cache_t cache</code> 为方法缓存，用于快速查找。</li>
<li><code>class_data_bits_t</code> 存储的类的信息。</li>
</ul>
<h4 id="cache-t"><a href="#cache-t" class="headerlink" title="cache_t"></a>cache_t</h4><p><code>cache_t</code> 为方法缓存，用于快速查找方法的执行函数。常规的方法调用，需要通过 <code>isa</code> 先去其类对象的方法列表中查找，找不到就去查找父类，依次查找到 <code>NSObject</code> 类，如果一些方法经常被调用，这样的方式效率较低，所以就设置一个方法缓存，当某个方法被调用过，就将其放入方法缓存列表，之后就优先查找方法缓存。</p>
<p><code>cache_t</code> 是一个可增量扩展的哈希表结构，使用哈希表实现可以提高查找效率。</p>
<p><code>cache_t</code> 可以简单理解为由一组 <code>bucket_t</code> 结构组成，后者的主要构成是 <code>SEL</code>和 <code>IMP</code>。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc-runtime-new.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> cache_t &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">public:</span><br><span class="line">    <span class="keyword">static</span> bucket_t *emptyBuckets();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">struct</span> bucket_t *buckets();</span><br><span class="line">    mask_t mask();</span><br><span class="line">    mask_t occupied();</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="bucket-t"><a href="#bucket-t" class="headerlink" title="bucket_t"></a>bucket_t</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc-runtime-new.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> bucket_t &#123;</span><br><span class="line">private:</span><br><span class="line">    <span class="comment">// IMP-first is better for arm64e ptrauth and no worse for arm64.</span></span><br><span class="line">    <span class="comment">// SEL-first is better for armv7* and i386 and x86_64.</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __arm64__</span></span><br><span class="line">    explicit_atomic&lt;uintptr_t&gt; _imp; <span class="comment">// 无类型的函数指针，对应具体的函数实现</span></span><br><span class="line">    explicit_atomic&lt;SEL&gt; _sel; <span class="comment">// 方法选择器</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    explicit_atomic&lt;SEL&gt; _sel;</span><br><span class="line">    explicit_atomic&lt;uintptr_t&gt; _imp;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>通过 <code>SEL</code> 可以找到对应的 <code>IMP</code>。</p>
<h4 id="class-data-bits-t"><a href="#class-data-bits-t" class="headerlink" title="class_data_bits_t"></a>class_data_bits_t</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc-runtime-new.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> class_data_bits_t &#123;</span><br><span class="line">    friend objc_class;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Values are the FAST_ flags above.</span></span><br><span class="line">    uintptr_t bits;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">public:</span><br><span class="line"></span><br><span class="line">    class_rw_t* data() <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (class_rw_t *)(bits &amp; FAST_DATA_MASK);</span><br><span class="line">    &#125; <span class="comment">// data，存储可动态改变的部分，内部还包含只读的部分</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Get the class&#x27;s ro data, even in the presence of concurrent realization.</span></span><br><span class="line">    <span class="comment">// fixme this isn&#x27;t really safe without a compiler barrier at least</span></span><br><span class="line">    <span class="comment">// and probably a memory barrier when realizeClass changes the data field</span></span><br><span class="line">    <span class="keyword">const</span> class_ro_t *safe_ro() &#123;</span><br><span class="line">        class_rw_t *maybe_rw = data();</span><br><span class="line">        <span class="keyword">if</span> (maybe_rw-&gt;flags &amp; RW_REALIZED) &#123;</span><br><span class="line">            <span class="comment">// maybe_rw is rw</span></span><br><span class="line">            <span class="keyword">return</span> maybe_rw-&gt;ro;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// maybe_rw is actually ro</span></span><br><span class="line">            <span class="keyword">return</span> (class_ro_t *)maybe_rw;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="comment">// 将只读部分暴露出来</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>class_data_bits_t</code> 主要是对 <code>class_rw_t</code> 的封装。</p>
<h4 id="class-rw-t"><a href="#class-rw-t" class="headerlink" title="class_rw_t"></a>class_rw_t</h4><p><code>class_rw_t</code> 存储类相关的读写信息，还包含 <code>class_ro_t</code>。</p>
<p>我们通常为类动态添加的方法、属性、协议都是在这里进行实现。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc-runtime-new.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> class_rw_t &#123;</span><br><span class="line">    <span class="comment">// Be warned that Symbolication knows the layout of this structure.</span></span><br><span class="line">    uint32_t flags;</span><br><span class="line">    uint16_t version;</span><br><span class="line">    uint16_t witness;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> class_ro_t *ro; <span class="comment">// 编译就确定，不能动态修改</span></span><br><span class="line"></span><br><span class="line">    method_array_t methods; <span class="comment">// 方法列表</span></span><br><span class="line">    property_array_t properties; <span class="comment">// 属性列表</span></span><br><span class="line">    protocol_array_t protocols; <span class="comment">// 协议列表</span></span><br><span class="line"></span><br><span class="line">    Class firstSubclass;</span><br><span class="line">    Class nextSiblingClass;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *demangledName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>主要包含：</p>
<ul>
<li><code>const class_ro_t *ro</code></li>
<li><code>method_array_t methods</code>，方法列表</li>
<li><code>property_array_t properties</code>，属性列表</li>
<li><code>protocol_array_t protocols</code>，协议列表</li>
</ul>
<p>其中 <code>method_array_t</code>、<code>property_array_t</code>、<code>protocol_array_t</code> 都是二维数组结构。</p>
<p>如果一个分类，分类中有若干方法，这一组方法就组成一个数组，然后这个数组作为 <code>methods</code> 的其中一个元素。</p>
<p>所以 <code>methods</code> 最终的组成元素就是一个个具体的方法，是 <code>method_t</code> 结构，属性和协议也类似。</p>
<h4 id="class-ro-t"><a href="#class-ro-t" class="headerlink" title="class_ro_t"></a>class_ro_t</h4><p><code>class_ro_t</code> 代表了类的相关只读信息，这些内容在编译时就确定。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc-runtime-new.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> class_ro_t &#123;</span><br><span class="line">    uint32_t flags;</span><br><span class="line">    uint32_t instanceStart;</span><br><span class="line">    uint32_t instanceSize;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __LP64__</span></span><br><span class="line">    uint32_t reserved;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> uint8_t * ivarLayout;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="type">char</span> * name; <span class="comment">// 类名</span></span><br><span class="line">    method_list_t * baseMethodList; <span class="comment">// 方法列表</span></span><br><span class="line">    protocol_list_t * baseProtocols; <span class="comment">// 协议列表</span></span><br><span class="line">    <span class="keyword">const</span> ivar_list_t * ivars; <span class="comment">// 变量列表</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> uint8_t * weakIvarLayout;</span><br><span class="line">    property_list_t *baseProperties; <span class="comment">// 属性列表</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    method_list_t *baseMethods() <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> baseMethodList;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>主要包含：</p>
<ul>
<li><code>const char * name</code>，类名</li>
<li><code>method_list_t * baseMethodList</code>，方法列表</li>
<li><code>protocol_list_t * baseProtocols</code>，协议列表</li>
<li><code>const ivar_list_t * ivars</code>，变量列表</li>
<li><code>property_list_t *baseProperties</code>，属性列表</li>
</ul>
<p>这里的列表都是一维数组，代表本类中最初设置的方法、属性等。</p>
<h4 id="method-t"><a href="#method-t" class="headerlink" title="method_t"></a>method_t</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc-runtime-new.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> method_t &#123;</span><br><span class="line">    SEL name; <span class="comment">// 方法名</span></span><br><span class="line">    <span class="keyword">const</span> <span class="type">char</span> *types; <span class="comment">// 方法类型</span></span><br><span class="line">    MethodListIMP imp; <span class="comment">// 方法实现地址</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> SortBySELAddress :</span><br><span class="line">        public std::binary_function&lt;<span class="keyword">const</span> method_t&amp;,</span><br><span class="line">                                    <span class="keyword">const</span> method_t&amp;, <span class="type">bool</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">bool</span> operator() (<span class="keyword">const</span> method_t&amp; lhs,</span><br><span class="line">                         <span class="keyword">const</span> method_t&amp; rhs)</span><br><span class="line">        &#123; <span class="keyword">return</span> lhs.name &lt; rhs.name; &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>函数四要素有：函数名、返回值、参数、函数体。</p>
<p><code>method_t</code> 中主要包含：</p>
<ul>
<li><code>SEL name</code>，包含方法名和参数个数信息</li>
<li><code>const char *types</code>，包含函数返回值和参数类型</li>
<li><code>MethodListIMP imp</code>，方法实现地址</li>
</ul>
<p>关于 <code>types</code>，需要参考 <a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html">Type Encodings</a>，一个方法的返回值以及参数类型，苹果定义了不同的字符来进行表示，其中第一个是返回值类型，后续依次接参数。</p>
<p>如 <code>-(void)aMethod</code> 方法，<code>types</code> 存储应该是 <code>v@:</code>，通过查表，三个字符分布代表 <code>void</code>、<code>id</code>、<code>SEL</code>，也就是说这个方法的返回值是 <code>void</code>，第一个参数是消息接受者，第二个参数是 <code>SEL</code>。</p>
<h4 id="protocol-t"><a href="#protocol-t" class="headerlink" title="protocol_t"></a>protocol_t</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc-runtime-new.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> protocol_t : objc_object &#123; <span class="comment">// 协议也是一个对象</span></span><br><span class="line">    <span class="keyword">const</span> <span class="type">char</span> *mangledName; <span class="comment">// 协议名</span></span><br><span class="line">    <span class="keyword">struct</span> protocol_list_t *protocols; <span class="comment">// 协议列表</span></span><br><span class="line">    method_list_t *instanceMethods; <span class="comment">// 实例方法</span></span><br><span class="line">    method_list_t *classMethods; <span class="comment">// 类方法</span></span><br><span class="line">    method_list_t *optionalInstanceMethods; <span class="comment">// 可选实例方法</span></span><br><span class="line">    method_list_t *optionalClassMethods; <span class="comment">// 可选类方法</span></span><br><span class="line">    property_list_t *instanceProperties; <span class="comment">// 实例属性</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="ivar-t"><a href="#ivar-t" class="headerlink" title="ivar_t"></a>ivar_t</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc-runtime-new.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> ivar_t &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __x86_64__</span></span><br><span class="line">    <span class="comment">// *offset was originally 64-bit on some x86_64 platforms.</span></span><br><span class="line">    <span class="comment">// We read and write only 32 bits of it.</span></span><br><span class="line">    <span class="comment">// Some metadata provides all 64 bits. This is harmless for unsigned </span></span><br><span class="line">    <span class="comment">// little-endian values.</span></span><br><span class="line">    <span class="comment">// Some code uses all 64 bits. class_addIvar() over-allocates the </span></span><br><span class="line">    <span class="comment">// offset for their benefit.</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    int32_t *offset; <span class="comment">// 地址的偏移</span></span><br><span class="line">    <span class="keyword">const</span> <span class="type">char</span> *name; <span class="comment">// 变量名</span></span><br><span class="line">    <span class="keyword">const</span> <span class="type">char</span> *type; <span class="comment">// 变量类型</span></span><br><span class="line">    <span class="comment">// alignment is sometimes -1; use alignment() instead</span></span><br><span class="line">    uint32_t alignment_raw;</span><br><span class="line">    uint32_t size;</span><br><span class="line"></span><br><span class="line">    uint32_t alignment() <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (alignment_raw == ~(uint32_t)<span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span>U &lt;&lt; WORD_SHIFT;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span> &lt;&lt; alignment_raw;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="property-t"><a href="#property-t" class="headerlink" title="property_t"></a>property_t</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc-runtime-new.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> property_t &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="type">char</span> *name; <span class="comment">// 属性名</span></span><br><span class="line">    <span class="keyword">const</span> <span class="type">char</span> *attributes; <span class="comment">// 属性修饰符</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="objc-object"><a href="#objc-object" class="headerlink" title="objc_object"></a>objc_object</h3><p>ObjC 中的 <code>id</code> 类型本质上就是一个 <code>objc_object</code> 的结构体指针，<code>objc_object</code> 结构体其实就是 ObjC 中对对象的实现。<code>objc_class</code> 继承自 <code>objc_object</code>，就是说，类也是对象。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Object.mm</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_object *<span class="type">id</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc-private.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> objc_object &#123;</span><br><span class="line">private:</span><br><span class="line">    isa_t isa;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关于 isa 的一些相关操作，如通过 isa 获取类对象、元类对象</span></span><br><span class="line">    <span class="comment">// 弱引用相关方法</span></span><br><span class="line">    <span class="comment">// 关联对象相关方法</span></span><br><span class="line">    <span class="comment">// 内存管理相关方法</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="isa"><a href="#isa" class="headerlink" title="isa"></a>isa</h4><p><code>objc_object</code> 中存在一个成员变量 <code>isa</code>，拥有 <code>isa</code> 在 ObjC 中就是对象。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc-private.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">union</span> isa_t &#123;</span><br><span class="line">    isa_t() &#123; &#125;</span><br><span class="line">    isa_t(uintptr_t value) : bits(value) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    Class cls;</span><br><span class="line">    uintptr_t bits;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(ISA_BITFIELD)</span></span><br><span class="line">    <span class="keyword">struct</span> &#123;</span><br><span class="line">        ISA_BITFIELD;  <span class="comment">// defined in isa.h</span></span><br><span class="line">    &#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>isa</code> 是一个联合体，在 64 位机器上这个共用体就是 64 位的（32 位下就是 32 位的）。</p>
<p><code>isa</code> 可能是指针型的，也可能是非指针型的。<br>指针型就是说这个联合体的内容存储的就是一个指针，比如一个对象的 <code>isa</code> 指针找到对象的类对象。<br>非指针型的是说，这个联合体中的部分位代表地址，其他位表示一些其他信息。因为 64 位用于存储地址是多余的，只需要部分位已经能满足寻址需要，那么其他剩余的位置就可以存储一些别的。</p>
<p><code>isa</code> 不总是指向实例所属的类，比如 <code>KVO</code> 就是将被观察对象的 <code>isa</code> 指向一个中间类。确定实例所属的类应该使用 <code>class</code> 方法。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// isa.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#   <span class="keyword">define</span> ISA_BITFIELD                                                      \</span></span><br><span class="line"><span class="meta">      uintptr_t nonpointer        : 1;                                       \</span></span><br><span class="line"><span class="meta">      uintptr_t has_assoc         : 1;                                       \</span></span><br><span class="line"><span class="meta">      uintptr_t has_cxx_dtor      : 1;                                       \</span></span><br><span class="line"><span class="meta">      uintptr_t shiftcls          : 33; <span class="comment">/*MACH_VM_MAX_ADDRESS 0x1000000000*/</span> \</span></span><br><span class="line"><span class="meta">      uintptr_t magic             : 6;                                       \</span></span><br><span class="line"><span class="meta">      uintptr_t weakly_referenced : 1;                                       \</span></span><br><span class="line"><span class="meta">      uintptr_t deallocating      : 1;                                       \</span></span><br><span class="line"><span class="meta">      uintptr_t has_sidetable_rc  : 1;                                       \</span></span><br><span class="line"><span class="meta">      uintptr_t extra_rc          : 19</span></span><br></pre></td></tr></table></figure>


<h2 id="对象模型"><a href="#对象模型" class="headerlink" title="对象模型"></a>对象模型</h2><p>除了一个特殊类 <code>NSProxy</code>，<code>NSObject</code> 类是所有类最终的父类（包括 <code>NSObject</code> 元类），<code>NSObject</code> 元类是所有类的元类（包括它自己）。</p>
<p>对象方法是存储在类对象的方法列表中，类方法是存储在元类对象的方法列表中。</p>
<p><img src="https://raw.githubusercontent.com/qiweipeng/images/master/20201001103418.jpg"></p>
<p>图 1 - 对象模型</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;Person实例地址：%@&quot;</span>, <span class="keyword">self</span>);</span><br><span class="line"></span><br><span class="line">Class personClass = objc_getClass(<span class="string">&quot;Person&quot;</span>);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;Person类对象地址：%p&quot;</span>, personClass);</span><br><span class="line"></span><br><span class="line">Class personMetaClass = objc_getMetaClass(<span class="string">&quot;Person&quot;</span>);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;Person元类对象地址：%p&quot;</span>, personMetaClass);</span><br><span class="line"></span><br><span class="line">Class personSuperClass = class_getSuperclass(personClass);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;Person父类类对象地址：%p&quot;</span>, personSuperClass);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSObject</span> *obj = [<span class="built_in">NSObject</span> new];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;NSObject实例地址：%@&quot;</span>, obj);</span><br><span class="line"></span><br><span class="line">Class objectClass = objc_getClass(<span class="string">&quot;NSObject&quot;</span>);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;NSObject类对象地址：%p&quot;</span>, objectClass);</span><br><span class="line"></span><br><span class="line">Class objectMetaClass = objc_getMetaClass(<span class="string">&quot;NSObject&quot;</span>);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;NSObject元类对象地址：%p&quot;</span>, objectMetaClass);</span><br><span class="line"></span><br><span class="line">Class objectSuperClass = class_getSuperclass(objectClass);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;NSObject父类类对象地址：%p&quot;</span>, objectSuperClass);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;Person实例对象的isa：%p&quot;</span>, object_getClass(<span class="keyword">self</span>));</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;Person类对象的isa：%p&quot;</span>, object_getClass(personClass));</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;Person元类对象的isa：%p&quot;</span>, object_getClass(personMetaClass));</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;NSObject实例对象的isa：%p&quot;</span>, object_getClass(obj));</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;NSObject类对象的isa：%p&quot;</span>, object_getClass(objectClass));</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;NSObject元类对象的isa：%p&quot;</span>, object_getClass(objectMetaClass));</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> Person实例地址：&lt;Person: 0x1005b5ef0&gt;</span></span><br><span class="line"><span class="comment"> Person类对象地址：0x100003208</span></span><br><span class="line"><span class="comment"> Person元类对象地址：0x1000031e0</span></span><br><span class="line"><span class="comment"> Person父类类对象地址：0x7fff970c7118</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> NSObject实例地址：&lt;NSObject: 0x103804920&gt;</span></span><br><span class="line"><span class="comment"> NSObject类对象地址：0x7fff970c7118</span></span><br><span class="line"><span class="comment"> NSObject元类对象地址：0x7fff970c70f0</span></span><br><span class="line"><span class="comment"> NSObject父类类对象地址：0x0</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> Person实例对象的isa：0x100003208</span></span><br><span class="line"><span class="comment"> Person类对象的isa：0x1000031e0</span></span><br><span class="line"><span class="comment"> Person元类对象的isa：0x7fff970c70f0</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> NSObject实例对象的isa：0x7fff970c7118</span></span><br><span class="line"><span class="comment"> NSObject类对象的isa：0x7fff970c70f0</span></span><br><span class="line"><span class="comment"> NSObject元类对象的isa：0x7fff970c70f0</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<h3 id="关于对象模型的若干知识点"><a href="#关于对象模型的若干知识点" class="headerlink" title="关于对象模型的若干知识点"></a>关于对象模型的若干知识点</h3><h4 id="调用类方法最终却调用了实例方法"><a href="#调用类方法最终却调用了实例方法" class="headerlink" title="调用类方法最终却调用了实例方法"></a>调用类方法最终却调用了实例方法</h4><p>由于 <code>NSObject</code> 元类对象父类是 <code>NSObject</code> 类对象，所以如果调用 <code>NSObject</code> 类方法没有对应实现，但是 <code>NSObject</code> 存在同名的对象方法时，会最终调用到该对象方法。</p>
<h4 id="super-关键字的实质"><a href="#super-关键字的实质" class="headerlink" title="super 关键字的实质"></a>super 关键字的实质</h4><p>super 不是一个指针，而是一个关键字，使用 <code>super</code> 的含义就是查找方法时，不在本类的类对象方法列表中查找，而是跳过他，直接从父类的类对象方法列表中开始进行查找。但是消息接受者都是实例本身。</p>
<p>如下面试题：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Student</span> : <span class="title">Person</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Student</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="variable language_">super</span> init];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, <span class="built_in">NSStringFromClass</span>([<span class="keyword">self</span> <span class="keyword">class</span>])); <span class="comment">// Student</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, <span class="built_in">NSStringFromClass</span>([<span class="variable language_">super</span> <span class="keyword">class</span>])); <span class="comment">// Student</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>最终两个打印结果都是 <code>Student</code>，原因是两者的方法接受者都是同一个实例，只不过查找方法时，一个是从本类的类对象开始，一个是从父类的类对象开始，但由于 <code>class</code> 方法是 <code>NSObject</code> 中的方法，最终都是寻找到根类然后执行，所以两者其实不管是调用者还是最终调用到的函数都是相同的。</p>
<p><code>[self class]</code> 本质上是调用 <code>objc_msgSend(id _Nullable self, SEL _Nonnull op, ...)</code>，<code>[super class]</code> 本质上是调用 <code>objc_msgSendSuper(struct objc_super * _Nonnull super, SEL _Nonnull op, ...)</code>。其中 <code>objc_super</code> 结构如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/// Specifies the superclass of an instance. </span></span><br><span class="line"><span class="keyword">struct</span> objc_super &#123;</span><br><span class="line">    <span class="comment">/// Specifies an instance of a class.</span></span><br><span class="line">    __<span class="keyword">unsafe_unretained</span> _Nonnull <span class="type">id</span> receiver; <span class="comment">// 还是调用者本身</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Specifies the particular superclass of the instance to message. </span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(__cplusplus)  &amp;&amp;  !__OBJC2__</span></span><br><span class="line">    <span class="comment">/* For compatibility with old objc-runtime.h header */</span></span><br><span class="line">    __<span class="keyword">unsafe_unretained</span> _Nonnull Class <span class="keyword">class</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    __<span class="keyword">unsafe_unretained</span> _Nonnull Class super_class;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* super_class is the first class to search */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中的 <code>receiver</code> 就是调用者本身。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://qiweipeng.github.io/2020/04/14/runtime-basic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="齐卫鹏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="齐卫鹏的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/14/runtime-basic/" class="post-title-link" itemprop="url">Objective-C Runtime 之一 基础介绍</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-14 19:30:54" itemprop="dateCreated datePublished" datetime="2020-04-14T19:30:54+08:00">2020-04-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-26 15:58:51" itemprop="dateModified" datetime="2024-11-26T15:58:51+08:00">2024-11-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本系列笔记参考 <code>Runtime</code> 源码为 <code>objc4-779.1</code>。</p>
<h2 id="什么是-Runtime"><a href="#什么是-Runtime" class="headerlink" title="什么是 Runtime"></a>什么是 Runtime</h2><p><code>Runtime</code> 是一套使用 C、C++、汇编实现的 API，调用 ObjC 方法时，实际上是执行的 <code>Runtime</code> 接口，最终执行的其实是 C&#x2F;C++ 代码。</p>
<p><code>Runtime</code> 可以理解为构成 ObjC 语言的一部分。ObjC 为 C 语言加上的面向对象的特性，通过 Clang 编译器和 <code>Runtime</code> 实现。</p>
<h2 id="编译-ObjC-文件"><a href="#编译-ObjC-文件" class="headerlink" title="编译 ObjC 文件"></a>编译 ObjC 文件</h2><p>使用 <code>clang -rewrite-objc Hello.m</code> 命令。</p>
<h2 id="使用-Runtime"><a href="#使用-Runtime" class="headerlink" title="使用 Runtime"></a>使用 Runtime</h2><h3 id="ObjC-方法调用"><a href="#ObjC-方法调用" class="headerlink" title="ObjC 方法调用"></a>ObjC 方法调用</h3><p>ObjC 方法调用本质上就是在调用 <code>Runtime</code> 的 API，比如使用 ObjC 编写如下代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Person *olivia = [[Person alloc] init];</span><br><span class="line">[olivia sayHi];</span><br></pre></td></tr></table></figure>

<p>使用命令 <code>clang -rewrite-objc main.m</code> 编译成 C++ 代码后如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Person *olivia = ((Person *(*)(id, SEL))(<span class="type">void</span> *)objc_msgSend)((id)((Person *(*)(id, SEL))(<span class="type">void</span> *)objc_msgSend)((id)<span class="built_in">objc_getClass</span>(<span class="string">&quot;Person&quot;</span>), <span class="built_in">sel_registerName</span>(<span class="string">&quot;alloc&quot;</span>)), <span class="built_in">sel_registerName</span>(<span class="string">&quot;init&quot;</span>));</span><br><span class="line">((<span class="built_in">void</span> (*)(id, SEL))(<span class="type">void</span> *)objc_msgSend)((id)olivia, <span class="built_in">sel_registerName</span>(<span class="string">&quot;sayHi&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>可以看到，ObjC 中调用方法本质上是在调用 <code>objc_msgSend</code> 函数：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// message.h</span></span><br><span class="line"></span><br><span class="line">OBJC_EXPORT <span class="type">id</span> _Nullable</span><br><span class="line">objc_msgSend(<span class="type">id</span> _Nullable <span class="keyword">self</span>, SEL _Nonnull op, ...)</span><br><span class="line">    OBJC_AVAILABLE(<span class="number">10.0</span>, <span class="number">2.0</span>, <span class="number">9.0</span>, <span class="number">1.0</span>, <span class="number">2.0</span>);</span><br></pre></td></tr></table></figure>

<p>这个函数第一个参数就是方法的调用者（<code>receiver</code>），第二个参数是 <code>SEL</code> 类型，上面代码中使用 <code>sel_registerName(&quot;方法名&quot;)</code> 获得，如果方法含有参数，那么就是 <code>objc_msgSend</code> 中第三个以及之后的参数。其中 <code>SEL</code> 就是 <code>方法选择器（selector）</code>，我们常常使用 <code>@selector()</code> 获得，它实际上是一个结构体指针。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// An opaque type that represents a method selector.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_selector *SEL;</span><br></pre></td></tr></table></figure>

<p>而 <code>sel_registerName</code> 就是通过方法名这个字符串去获得 <code>SEL</code>：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OBJC_EXPORT SEL _Nonnull</span><br><span class="line">sel_registerName(<span class="keyword">const</span> <span class="type">char</span> * _Nonnull str)</span><br><span class="line">    OBJC_AVAILABLE(<span class="number">10.0</span>, <span class="number">2.0</span>, <span class="number">9.0</span>, <span class="number">1.0</span>, <span class="number">2.0</span>);</span><br></pre></td></tr></table></figure>

<p>需要注意的是，这里说的方法名包含参数个数信息，不包含参数类型和返回值类型信息，也就是说，我们可以从一个 <code>SEL</code> 中得到这个方法的名字以及有几个参数（如 <code>sayHi:</code> 表示这个方法具有一个参数），但是无法知道这个方法的返回值类型和参数类型。所以 ObjC 中如果函数名相同且参数个数相同，即使返回值类型和参数类型都不同，编译器也是会报错的。</p>
<h3 id="NSObject-方法"><a href="#NSObject-方法" class="headerlink" title="NSObject 方法"></a>NSObject 方法</h3><p>NSObject 中的方法大多都是调用的 <code>Runtime</code> 的 API：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">id</span>)performSelector:(SEL)aSelector;</span><br><span class="line">- (<span class="type">id</span>)performSelector:(SEL)aSelector withObject:(<span class="type">id</span>)object;</span><br><span class="line">- (<span class="type">id</span>)performSelector:(SEL)aSelector withObject:(<span class="type">id</span>)object1 withObject:(<span class="type">id</span>)object2;</span><br><span class="line"></span><br><span class="line">- (<span class="type">BOOL</span>)isProxy;</span><br><span class="line"></span><br><span class="line">- (<span class="type">BOOL</span>)isKindOfClass:(Class)aClass;</span><br><span class="line">- (<span class="type">BOOL</span>)isMemberOfClass:(Class)aClass;</span><br><span class="line">- (<span class="type">BOOL</span>)conformsToProtocol:(Protocol *)aProtocol;</span><br><span class="line"></span><br><span class="line">- (<span class="type">BOOL</span>)respondsToSelector:(SEL)aSelector;</span><br></pre></td></tr></table></figure>

<h3 id="直接调用-Runtime-库函数"><a href="#直接调用-Runtime-库函数" class="headerlink" title="直接调用 Runtime 库函数"></a>直接调用 Runtime 库函数</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="string">&lt;objc/message.h&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>可以通过引入 <code>Runtime</code> 头文件，直接调用 <code>Runtime</code> 中的 API，基于 <code>Runtime</code> 的很多实现也是通过调用 <code>Runtime</code> API 完成的。</p>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ol>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40008048-CH1-SW1">Objective-C Runtime Programming Guide</a></li>
<li><a target="_blank" rel="noopener" href="http://yulingtianxia.com/blog/2014/11/05/objective-c-runtime/#SEL">Objective-C Runtime - 玉令天下的博客</a></li>
<li><a target="_blank" rel="noopener" href="http://yulingtianxia.com/blog/2016/06/15/Objective-C-Message-Sending-and-Forwarding/">Objective-C 消息发送与转发机制原理 - 玉令天下的博客</a></li>
<li><a target="_blank" rel="noopener" href="http://yulingtianxia.com/blog/2015/12/06/The-Principle-of-Refenrence-Counting/#isa-%E6%8C%87%E9%92%88%EF%BC%88NONPOINTER-ISA%EF%BC%89">Objective-C 引用计数原理 - 玉令天下的博客</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://qiweipeng.github.io/2020/03/24/swift-package-usage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="齐卫鹏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="齐卫鹏的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/24/swift-package-usage/" class="post-title-link" itemprop="url">Swift Package 的创建和使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-24 20:56:51" itemprop="dateCreated datePublished" datetime="2020-03-24T20:56:51+08:00">2020-03-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-26 15:58:51" itemprop="dateModified" datetime="2024-11-26T15:58:51+08:00">2024-11-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Xcode 11 已经有了对 Swift Package 的支持，今后使用 Swift 编写的 iOS 项目就可以开始尝试使用 SwiftPM 逐步替换 CocoaPods 和 Carthage 了。常用的使用 Swift 编写的三方库如 <code>Alamofire</code>、<code>Moya</code> 等也都已经支持了 SwiftPM。</p>
<p>本文通过一个例子来介绍 Swift Package 的创建、发布以及使用。</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>由于打算将创建的 Package 发布到 Github，首先需要在 Xcode 上登陆 Github，这将方便后续的上传和下载集成。</p>
<h2 id="Swift-Package-的创建"><a href="#Swift-Package-的创建" class="headerlink" title="Swift Package 的创建"></a>Swift Package 的创建</h2><p>Xcode 快捷键 <code>shift + control + command + N</code> 可以快速创建一个 Swift Package，我们命名为 <code>Hello</code>。创建项目的时候勾选 <code>Create Git repository on my Mac</code>，因为后续还要上传 Github。</p>
<p>创建后，目录中会有一个 <code>Package.swift</code> 文件，一个 <code>Sources</code> 文件夹包含着这个包将要包含的代码，以及一个 <code>Tests</code> 文件夹包含测试文件。</p>
<p>其中，<code>Hello.swift</code> 文件中代码为</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> text <span class="operator">=</span> <span class="string">&quot;Hello, World!&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于做成 Package 之后就是跨模块访问，我们加上访问控制关键字，并创建一个构造器（因为默认的构造器是 internal 关键字），然后增加一个方法。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> text: <span class="type">String</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(<span class="params">with</span> <span class="params">text</span>: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;Hell, World!&quot;</span>) &#123; <span class="comment">// there is a bug.</span></span><br><span class="line">        <span class="keyword">self</span>.text <span class="operator">=</span> text</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">sayHi</span>() -&gt; <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> text</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后我们可以提交并上传了，但是这里我们预留了一个 bug。</p>
<p>我们将代码推到 Github 上的流程，可以先在 Github 上创建一个空项目，然后本地和远程仓库关联，也可以直接通过 Xcode 在 Github 上创建一个远程仓库（因为已经在 Xcode 上登陆了 Github，这一步非常简单）。这个仓库完全可以设置为私有的，也就是说我们为自己项目创建的 Package 是可以托管在 Github 上的。</p>
<p>下一步是为当前 Git 版本打标签，这将成为 Package 的版本号。需要说明的是，这个版本号是遵守语义化版本控制规范的，具体可参考 <a target="_blank" rel="noopener" href="https://semver.org/">Semantic Versioning 2.0.0</a>。打了标签之后，记得还需要 Push 一次，将标签同步到远程仓库中。至此，我们已经创建一个 Swift Package 并上传到了 Github。</p>
<h2 id="Swift-Package-的使用"><a href="#Swift-Package-的使用" class="headerlink" title="Swift Package 的使用"></a>Swift Package 的使用</h2><p>我们再新建一个项目，名为 Demo，之后尝试添加之前的 Package。</p>
<p><img src="https://raw.githubusercontent.com/qiweipeng/images/master/20201001104009.png"></p>
<p>图 1 - 创建 Swift Package</p>
<p>点击加号后，由于已经登陆了 Github，弹出的列表中可以找到之前创建的 Package，当然也可以复制 URL 进行搜索。找到后，会提示我们设置版本规则。其中，默认的 <code>Up to Next Major</code> 的意思是从指定的版本到下个大版本，这样进行小版本更新时，我们可以轻松对 Package 进行更新。再次点击下一步后，会提示选取 Product 以及添加到的 Target，我们都不加修改点击完成。这样，这个 Package 就集成到我们都项目中了。</p>
<p>之后我们在项目中使用一下。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  main.swift</span></span><br><span class="line"><span class="comment">//  Demo</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Hello</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> hello <span class="operator">=</span> <span class="type">Hello</span>()</span><br><span class="line"><span class="built_in">print</span>(hello.sayHi()) <span class="comment">// Hell, World!</span></span><br></pre></td></tr></table></figure>

<p>至此，我们成功地在项目中集成并使用了一个 Swift Package。</p>
<h2 id="修改-Package"><a href="#修改-Package" class="headerlink" title="修改 Package"></a>修改 Package</h2><p>我们这个 Package 是有问题的，输出的不是 <code>Hello</code> 而是 <code>Hell</code>。</p>
<p>所以我们进一步可以去修改那个 Package，然后再次上传。对于新的版本需要打一个新的标签，由于只是 bug 修复，新版本就是 <code>1.0.1</code>。</p>
<p>之后对于 Demo 项目，要做的只需要更新 Package 到最新版本，操作是 <code>File-&gt;Swift Packages-&gt;Update to Latest Package Versions</code>，之后这个 Package 就会更新到 <code>1.0.1</code> 版本，这个项目我们不修改任何代码重新运行，打印结果从 <code>Hell, World!</code> 修正为 <code>Hello, World!</code>。</p>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ol>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/videos/play/wwdc2019/408">Adopting Swift Packages in Xcode</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/videos/play/wwdc2019/410">Creating Swift Packages</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://qiweipeng.github.io/2018/04/07/some-git-commands/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="齐卫鹏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="齐卫鹏的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/04/07/some-git-commands/" class="post-title-link" itemprop="url">记录一些 Git 的命令</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-04-07 19:42:56" itemprop="dateCreated datePublished" datetime="2018-04-07T19:42:56+08:00">2018-04-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-26 15:58:51" itemprop="dateModified" datetime="2024-11-26T15:58:51+08:00">2024-11-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Sourcetree 莫名无法登陆 Atlassian 账号之后，打算尝试用命令行操作 Git，但是用习惯了 GUI，Git 命令都快忘的一干二净了。于是又打开廖雪峰老师的 Git 教程，准备再仔细过一遍。同时结合其他 Git 教程，把 Git 的基本概念、使用再重新梳理一遍。这里就记录一些常用的 Git 命令。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 设置全局的用户名和邮箱</span><br><span class="line">$ git config --global user.name &quot;&lt;name&gt;&quot;</span><br><span class="line">$ git config --global user.email &quot;&lt;email address&gt;&quot;</span><br><span class="line"></span><br><span class="line">// 让 Git 输出语句显示颜色</span><br><span class="line">$ git config --global color.ui true</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// 创建版本库</span><br><span class="line">$ git init</span><br><span class="line"></span><br><span class="line">// 当前 Git 状态</span><br><span class="line">$ git status</span><br><span class="line"></span><br><span class="line">// 添加指定文件到暂存区，包括新增和修改</span><br><span class="line">$ git add &lt;file&gt;</span><br><span class="line"></span><br><span class="line">// 添加工作区所有修改到暂存区，包括新增、修改、删除</span><br><span class="line">$ git add -A</span><br><span class="line"></span><br><span class="line">// 提交暂存区内容到当前分支</span><br><span class="line">$ git commit -m &quot;&lt;descriptive message&gt;&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// 工作区和暂存区的不同</span><br><span class="line">$ git diff</span><br><span class="line">$ git diff &lt;file&gt;</span><br><span class="line"></span><br><span class="line">// 工作区和当前分支的不同</span><br><span class="line">$ git diff HEAD</span><br><span class="line">$ git diff HEAD &lt;file&gt;</span><br><span class="line"></span><br><span class="line">// 暂存区和当前分支的不同</span><br><span class="line">$ git diff --staged</span><br><span class="line">$ git diff --staged &lt;file&gt;</span><br><span class="line"></span><br><span class="line">// 查看历史提交记录</span><br><span class="line">$ git log</span><br><span class="line"></span><br><span class="line">// 这几个参数的意义：--graph 显示分支合并图，--pretty=oneline 只显示一行简化信息 --abbrev-commit 提交的版本号只显示前面 7 位</span><br><span class="line">$ git log --graph --pretty=oneline --abbrev-commit</span><br><span class="line"></span><br><span class="line">// 查看每一次命令</span><br><span class="line">$ git reflog</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// 回到上一个提交的版本，工作区保持原状</span><br><span class="line">$ git reset HEAD^</span><br><span class="line"></span><br><span class="line">// 回到上一个提交的版本，工作区和暂存区都刷新</span><br><span class="line">$ git reset --hard HEAD^</span><br><span class="line"></span><br><span class="line">// reset 有三种情况</span><br><span class="line">// --mixed：会影响到暂存区和历史记录区，也是默认选项</span><br><span class="line">// --soft：只影响历史记录区</span><br><span class="line">// --hard：影响工作区、暂存区和历史记录区</span><br><span class="line"></span><br><span class="line">// 将工作区修改撤销到上次 add 或者 commit 时的状态，如果文件名和分支名没有冲突 -- 可以省略</span><br><span class="line">$ git checkout -- &lt;file&gt;</span><br><span class="line"></span><br><span class="line">// 如果已经添加到暂存区，希望恢复到上次 commit 的状态，可先进行这一步将暂存区内容撤销</span><br><span class="line">$ git reset HEAD &lt;file&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 如果文件被删除，这个命令将这个改变添加到暂存区</span><br><span class="line">$ git rm &lt;file&gt;</span><br><span class="line"></span><br><span class="line">// 将暂存区中这个文件删除</span><br><span class="line">$ git rm --cached &lt;file&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// 为本地已有仓库添加远程仓库，远程仓库名为 origin （一个仓库可以添加多个远程仓库）</span><br><span class="line">$ git remote add origin git@github.com:michaelliao/learngit.git</span><br><span class="line"></span><br><span class="line">// 查看远程仓库</span><br><span class="line">$ git remote</span><br><span class="line"></span><br><span class="line">// 查看远程仓库详细信息，可以查看是否有 push 权限</span><br><span class="line">git remote -v</span><br><span class="line"></span><br><span class="line">// 将 master 分支推送到远程仓库 origin</span><br><span class="line">$ git push origin master</span><br><span class="line">// 将 dev 分支推送到远程仓库 origin</span><br><span class="line">$ git push origin dev</span><br><span class="line"></span><br><span class="line">// 第一次推送时，使用 -u 可以把本地的 master 分支和远程的 master 分支关联起来，以后就可以省略</span><br><span class="line">$ git push -u origin master</span><br><span class="line"></span><br><span class="line">// 将一个远程仓库复制到本地</span><br><span class="line">$ git clone &lt;url&gt;</span><br><span class="line"></span><br><span class="line">// 删除一个关联的远程仓库</span><br><span class="line">$ git remote remove origin</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">// 查看分支</span><br><span class="line">$ git branch</span><br><span class="line"></span><br><span class="line">// 新建分支</span><br><span class="line">$ git branch &lt;branch-name&gt;</span><br><span class="line"></span><br><span class="line">// 切换到分支</span><br><span class="line">$ git checkout &lt;branch-name&gt;</span><br><span class="line">// 切换到分支（新）</span><br><span class="line">$ git switch master</span><br><span class="line"></span><br><span class="line">// 新建并切换到分支</span><br><span class="line">$ git checkout -b &lt;branch-name&gt;</span><br><span class="line">// 新建并切换到分支（新）</span><br><span class="line">$ git switch -c dev</span><br><span class="line"></span><br><span class="line">// 将指定分支合并到当前分支</span><br><span class="line">$ git merge &lt;branch-name&gt;</span><br><span class="line"></span><br><span class="line">// 变基（主要用于将公共分支的变更合并的 feature 分支）</span><br><span class="line">$ git rebase &lt;branch-name&gt;</span><br><span class="line"></span><br><span class="line">// 删除指定分支</span><br><span class="line">$ git branch -d &lt;branch-name&gt;</span><br><span class="line"></span><br><span class="line">// 如果 dev 分支修改过程中，master 分支从没有修改过，那么 Git 默认会使用 Fast forward 模式合并，不会产生新的 commit，而是直接把 master 的指针指向 dev 分支最后的 commit 上，我们并不会在分支历史中看到分支信息，如果一定要看到，可以指定非 Fast forward 模式合并，这种模式合并，一定会新产生一个 commit</span><br><span class="line">// 使用非 Fast forward 模式合并，附带 commit 的信息</span><br><span class="line">$ git merge --no-ff -m &quot;merge with no-ff&quot; dev</span><br><span class="line"></span><br><span class="line">// 强行删除指定分支，即使其还没有合并到主分支</span><br><span class="line">$ git branch -D feature-vulcan</span><br><span class="line"></span><br><span class="line">// 从远程仓库拉去 dev 分支到本地</span><br><span class="line">$ git checkout -b dev origin/dev</span><br><span class="line"></span><br><span class="line">// 将当前分支远程仓库最新的内容拉取下来</span><br><span class="line">$ git pull</span><br><span class="line"></span><br><span class="line">// 更改远程分区的 HEAD 到 develop 分支</span><br><span class="line">git remote set-head origin develop</span><br><span class="line"></span><br><span class="line">// 将本地的 dev 分支与远端的 dev 分支做关联（？）</span><br><span class="line">$ git branch --set-upstream-to=origin/dev dev</span><br><span class="line">// 推送本地新建的 dev 分支到远端</span><br><span class="line">git push --set-upstream origin dev</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(本段摘自廖雪峰 Git 教程)</span><br><span class="line">多人协作的工作模式通常是这样：</span><br><span class="line"></span><br><span class="line">首先，可以试图用git push origin branch-name推送自己的修改；</span><br><span class="line"></span><br><span class="line">如果推送失败，则因为远程分支比你的本地更新，需要先用git pull试图合并；</span><br><span class="line"></span><br><span class="line">如果合并有冲突，则解决冲突，并在本地提交；</span><br><span class="line"></span><br><span class="line">没有冲突或者解决掉冲突后，再用git push origin branch-name推送就能成功！</span><br><span class="line"></span><br><span class="line">// 这部分不一定对，有的已经废弃了</span><br><span class="line">如果git pull提示“no tracking information”，则说明本地分支和远程分支的链接关系没有创建，用命令git branch --set-upstream-to=origin/dev dev。</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// 暂时缓存当前工作区</span><br><span class="line">$ git stash</span><br><span class="line"></span><br><span class="line">// 查看 stash 列表</span><br><span class="line">$ git stash list</span><br><span class="line"></span><br><span class="line">// 恢复 stash 内容，但是 stash 并不删除</span><br><span class="line">$ git stash apply stash@&#123;0&#125;</span><br><span class="line"></span><br><span class="line">// 删除 stash 内容</span><br><span class="line">$ git stash drop</span><br><span class="line"></span><br><span class="line">// 恢复 stash 最近的内容，并删除</span><br><span class="line">$ git stash pop</span><br><span class="line"></span><br><span class="line">// 将某个提交的变化复制到当前分支</span><br><span class="line">$ git cherry-pick 4c805e2</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">// 查看所有标签</span><br><span class="line">$ git tag</span><br><span class="line"></span><br><span class="line">// 为当前分支最新提交打上标签</span><br><span class="line">$ git tag v1.0</span><br><span class="line"></span><br><span class="line">// 为历史提交中的某次提交打上标签</span><br><span class="line">$ git tag v0.9 &lt;commit id&gt;</span><br><span class="line"></span><br><span class="line">// 查看指定标签的信息</span><br><span class="line">$ git show &lt;tag name&gt;</span><br><span class="line"></span><br><span class="line">// 创建标签的过程中添加标签的说明</span><br><span class="line">$ git tag -a v0.1 -m &quot;version 0.1 released&quot; 3628164</span><br><span class="line"></span><br><span class="line">// 删除指定标签</span><br><span class="line">$ git tag -d &lt;tag name&gt;</span><br><span class="line"></span><br><span class="line">// 推送一个本地标签</span><br><span class="line">$ git push origin &lt;tag name&gt;</span><br><span class="line"></span><br><span class="line">// 推送全部未推送过的本地标签</span><br><span class="line">$ git push origin --tags</span><br><span class="line"></span><br><span class="line">// 删除一个远程标签</span><br><span class="line">$ git push origin :refs/tags/&lt;tag name&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 给常用 Git 命令设置别名，以快捷输入，这个依然是保存在家目录的 .gitconfig 文件中</span><br><span class="line">$ git config --global alias.st status</span><br><span class="line">$ git config --global alias.co checkout</span><br><span class="line">$ git config --global alias.ci commit</span><br><span class="line">$ git config --global alias.br branch</span><br><span class="line">$ git config --global alias.unstage &#x27;reset HEAD&#x27;</span><br><span class="line">$ git config --global alias.last &#x27;log -1&#x27;</span><br><span class="line">$ git config --global alias.lg &quot;log --color --graph --pretty=format:&#x27;%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)&lt;%an&gt;%Creset&#x27; --abbrev-commit&quot;</span><br></pre></td></tr></table></figure>

<p>链接：</p>
<p><a target="_blank" rel="noopener" href="https://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000">廖雪峰的 Git 教程</a>：Git 入门最好的教程。</p>
<p><a target="_blank" rel="noopener" href="http://nvie.com/posts/a-successful-git-branching-model/">Git Flow</a>：Git Flow 的原文，里面的图片一目了然。</p>
<p><a target="_blank" rel="noopener" href="https://services.github.com/on-demand/downloads/github-git-cheat-sheet.pdf">GitHub Git Cheat Sheet</a>：各种 Git 基本操作的命令。</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/mbuApV5nZaJxep9M-i_UFA">工作流一目了然，看小姐姐用动图展示 10 大 Git 命令</a>：一些 Git 操作的动图解释。</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/tEC4VSy0xOA0hmlV4qstJw">面试中的那些 Git 问题 - 基础部分</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">齐卫鹏</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">44</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">齐卫鹏</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
